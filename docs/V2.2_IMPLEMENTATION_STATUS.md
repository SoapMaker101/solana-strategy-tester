# v2.2 — Implementation Status

## Scope
This document describes changes introduced in v2.2.

## What Changed

### Explicit Pandas Checks
- Replaced implicit truthiness checks (`if df:`, `if series:`) with explicit checks:
  - `if df is not None and not df.empty:`
  - `if series is not None and not series.empty:`
  - `if mask.any():` for boolean masks
- Added helper functions in `backtester/utils/typing_utils.py`:
  - `is_nonempty_df()`, `is_nonempty_series()`
  - `ensure_df()`, `ensure_series()`

### Optional Typing Normalization
- Normalized `NaT` to `None` at type boundaries:
  - `as_utc_datetime()` now returns `Optional[pd.Timestamp]` (never NaT)
  - Explicit checks for `pd.isna()` before returning values
- Fixed datetime assignments in `runner_ladder.py`:
  - `datetime | NaTType` → `datetime | None` via normalization

### Type Narrowing for Method Calls
- Added runtime guards before calling pandas methods:
  - `fillna()`: `assert isinstance(x, pd.Series)` or `if isinstance(x, pd.Series):`
  - `sort_values()`: explicit `by=` keyword argument
  - `to_frame()`: explicit Series conversion before call

### Localized Type Ignores
- Added `# type: ignore[reportCallIssue]` for known stub limitations:
  - `dataclass` decorator with `kw_only=True`
  - Factory method kwargs (`cls(...)` calls)
  - `PortfolioResult` constructor kwargs
  - `sort_values` overload resolution
- All ignores include comment: "basedpyright limitation; runtime covered by tests"

## What Did NOT Change

- Strategy logic
- Portfolio logic
- Stage A / Stage B behavior
- Test suite (all tests remain green)
- Event contracts
- Data contracts
- Runner-only semantics

## Why This Matters

- **Predictable behavior**: Explicit checks are easier to reason about
- **Lower cognitive load**: No hidden truthiness semantics
- **Cleaner future diffs**: Type-safe code is easier to refactor
- **Safer refactors**: Type checker catches more errors at development time

## Verification

- All pytest tests green (308 passed)
- basedpyright reports zero problems (or only documented ignores)
- Guard tests remain green:
  - `tests/domain/test_strategy_output_contract.py`
  - `tests/application/test_portfolio_config_guards.py`
  - `tests/decision/test_stage_b_v2_gate_contract.py`

## Files Modified

- `backtester/utils/typing_utils.py` — helper functions
- `backtester/application/runner.py` — `safe_float()` usage
- `backtester/audit/indices.py` — explicit checks
- `backtester/audit/invariant_checker.py` — explicit checks
- `backtester/decision/strategy_selector.py` — explicit checks, runtime guards
- `backtester/domain/portfolio_events.py` — type ignores for dataclass
- `backtester/domain/runner_ladder.py` — datetime normalization
- `backtester/infrastructure/reporter.py` — sort_values, fillna guards
- `backtester/research/signal_quality/filter_signals.py` — to_frame guards

## Migration Notes

No migration required. This is a typing-only change with zero behavior impact.

