# ๐๏ธ ะััะธัะตะบัััะฝัะน ะฐะฝะฐะปะธะท: Solana Strategy Tester

**ะะฐัะฐ ัะพะทะดะฐะฝะธั:** 2025-12-14  
**ะะตััะธั:** 1.0

---

## ๐ ะะฑะทะพั

ะะพะบัะผะตะฝั ะพะฟะธััะฒะฐะตั ะฐััะธัะตะบัััั ะฟัะพะตะบัะฐ Solana Strategy Tester: ััััะบัััั ะผะพะดัะปะตะน, ะธั ะฝะฐะทะฝะฐัะตะฝะธะต, ะฒะทะฐะธะผะพัะฒัะทะธ ะธ ะพัะฒะตัััะฒะตะฝะฝะพััั ะบะฐะถะดะพะณะพ ะบะพะผะฟะพะฝะตะฝัะฐ. ะัะพะตะบั ัะปะตะดัะตั ะฟัะธะฝัะธะฟะฐะผ Clean Architecture ั ัะตัะบะธะผ ัะฐะทะดะตะปะตะฝะธะตะผ ะฝะฐ ัะปะพะธ.

---

## ๐ฏ ะััะธัะตะบัััะฝัะต ะฟัะธะฝัะธะฟั

1. **Clean Architecture** โ ัะฐะทะดะตะปะตะฝะธะต ะฝะฐ ัะปะพะธ (domain, application, infrastructure)
2. **Dependency Inversion** โ ะทะฐะฒะธัะธะผะพััั ะพั ะฐะฑัััะฐะบัะธะน, ะฐ ะฝะต ะพั ะบะพะฝะบัะตัะฝัั ัะตะฐะปะธะทะฐัะธะน
3. **Single Responsibility** โ ะบะฐะถะดัะน ะผะพะดัะปั ะพัะฒะตัะฐะตั ะทะฐ ะพะดะฝั ะทะฐะดะฐัั
4. **Open/Closed** โ ะพัะบััั ะดะปั ัะฐััะธัะตะฝะธั, ะทะฐะบััั ะดะปั ะผะพะดะธัะธะบะฐัะธะธ

---

## ๐ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
backtester/
โโโ application/          # ะกะปะพะน ะฟัะธะปะพะถะตะฝะธั (ะพัะบะตัััะฐัะธั)
โโโ domain/              # ะะธะทะฝะตั-ะปะพะณะธะบะฐ (ัะดัะพ ัะธััะตะผั)
โโโ infrastructure/      # ะะฝััะฐััััะบัััะฝัะน ัะปะพะน (I/O, ะฒะฝะตัะฝะธะต ะทะฐะฒะธัะธะผะพััะธ)
โโโ research/            # ะััะปะตะดะพะฒะฐัะตะปััะบะธะน ัะปะพะน (ะฐะฝะฐะปะธะท ัััะพะนัะธะฒะพััะธ)
โโโ decision/            # ะกะปะพะน ะฟัะธะฝััะธั ัะตัะตะฝะธะน (ะพัะฑะพั ัััะฐัะตะณะธะน)
โโโ utils/               # ะฃัะธะปะธัั ะพะฑัะตะณะพ ะฝะฐะทะฝะฐัะตะฝะธั
```

---

## ๐ฏ Domain Layer (ะะธะทะฝะตั-ะปะพะณะธะบะฐ)

**ะะฐะทะฝะฐัะตะฝะธะต:** ะฏะดัะพ ัะธััะตะผั, ัะพะดะตัะถะธั ะฑะธะทะฝะตั-ะปะพะณะธะบั, ะฝะตะทะฐะฒะธัะธะผัั ะพั ะฒะฝะตัะฝะธั ะทะฐะฒะธัะธะผะพััะตะน.

### `models.py` โ ะะพะดะตะปะธ ะดะฐะฝะฝัั

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะฟัะตะดะตะปะตะฝะธะต ะพัะฝะพะฒะฝัั ััััะบััั ะดะฐะฝะฝัั ัะธััะตะผั.

**ะัะฝะพะฒะฝัะต ะบะปะฐััั:**
- `Signal` โ ะฒัะพะดะฝะพะน ัะธะณะฝะฐะป ะดะปั ัะพัะณะพะฒะปะธ (id, contract_address, timestamp, source, narrative, extra)
- `Candle` โ OHLCV ัะฒะตัะฐ (timestamp, open, high, low, close, volume)
- `StrategyInput` โ ะฒัะพะดะฝัะต ะดะฐะฝะฝัะต ะดะปั ัััะฐัะตะณะธะธ (signal, candles, global_params)
- `StrategyOutput` โ ัะตะทัะปััะฐั ัะฐะฑะพัั ัััะฐัะตะณะธะธ (entry_time, entry_price, exit_time, exit_price, pnl, reason, meta)

**ะะฐะฒะธัะธะผะพััะธ:** ะขะพะปัะบะพ ััะฐะฝะดะฐััะฝะฐั ะฑะธะฑะปะธะพัะตะบะฐ Python (dataclasses, datetime, typing)

---

### `strategy_base.py` โ ะะฐะทะพะฒัะน ะบะปะฐัั ัััะฐัะตะณะธะน

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะฟัะตะดะตะปะตะฝะธะต ะธะฝัะตััะตะนัะฐ ะดะปั ะฒัะตั ัััะฐัะตะณะธะน.

**ะัะฝะพะฒะฝัะต ะบะปะฐััั:**
- `StrategyConfig` โ ะบะพะฝัะธะณััะฐัะธั ัััะฐัะตะณะธะธ (name, type, params)
- `Strategy` (ABC) โ ะฐะฑัััะฐะบัะฝัะน ะฑะฐะทะพะฒัะน ะบะปะฐัั ัะพ ะผะตัะพะดะพะผ `on_signal()`

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต:** ะัะต ะบะพะฝะบัะตัะฝัะต ัััะฐัะตะณะธะธ ะฝะฐัะปะตะดััััั ะพั `Strategy`

**ะะฐะฒะธัะธะผะพััะธ:** `models.py`

---

### `rr_strategy.py` โ RR ัััะฐัะตะณะธั

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะตะฐะปะธะทะฐัะธั ะบะปะฐััะธัะตัะบะพะน Risk/Reward ัััะฐัะตะณะธะธ (ะฒัะพะด ะฝะฐ ะฟะตัะฒะพะน ัะฒะตัะต, ะฒััะพะด ะฟะพ TP/SL).

**ะัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั:**
- `RRStrategy` โ ะบะปะฐัั ัััะฐัะตะณะธะธ
- ะัะฟะพะปัะทัะตั `rr_utils.py` ะดะปั ะพะฑัะตะน ะปะพะณะธะบะธ TP/SL

**ะะฐัะฐะผะตััั:**
- `tp_multiplier` โ ะผะฝะพะถะธัะตะปั ะดะปั Take Profit
- `sl_multiplier` โ ะผะฝะพะถะธัะตะปั ะดะปั Stop Loss
- `timeout_minutes` โ ะผะฐะบัะธะผะฐะปัะฝะพะต ะฒัะตะผั ัะดะตัะถะฐะฝะธั ะฟะพะทะธัะธะธ

**ะะฐะฒะธัะธะผะพััะธ:** `strategy_base.py`, `rr_utils.py`, `trade_features.py`

---

### `rrd_strategy.py` โ RRD ัััะฐัะตะณะธั

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะตะฐะปะธะทะฐัะธั ัััะฐัะตะณะธะธ ั ะพัะปะพะถะตะฝะฝัะผ ะฒัะพะดะพะผ ะฟะพ drawdown.

**ะัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั:**
- `RRDStrategy` โ ะบะปะฐัั ัััะฐัะตะณะธะธ
- ะะพะณะธะบะฐ ะพะถะธะดะฐะฝะธั ะฟัะพัะฐะดะบะธ ะฟะตัะตะด ะฒัะพะดะพะผ
- ะัะฟะพะปัะทัะตั `rr_utils.py` ะดะปั ะปะพะณะธะบะธ TP/SL ะฟะพัะปะต ะฒัะพะดะฐ

**ะะฐัะฐะผะตััั:**
- `drawdown_pct` โ ะฟัะพัะตะฝั ะฟัะพัะฐะดะบะธ ะดะปั ะฒัะพะดะฐ
- `tp_multiplier`, `sl_multiplier`, `timeout_minutes` โ ะบะฐะบ ะฒ RR ัััะฐัะตะณะธะธ

**ะะฐะฒะธัะธะผะพััะธ:** `strategy_base.py`, `rr_utils.py`, `trade_features.py`, `price_loader` (ะดะปั ะดะพะณััะทะบะธ ัะฒะตัะตะน)

---

### `runner_strategy.py` โ Runner ัััะฐัะตะณะธั

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะัะพััะฐั ัััะฐัะตะณะธั buy & hold (ะฒัะพะด ะฝะฐ ะฟะตัะฒะพะน ัะฒะตัะต, ะฒััะพะด ะฝะฐ ะฟะพัะปะตะดะฝะตะน).

**ะัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั:**
- `RunnerStrategy` โ ะบะปะฐัั ัััะฐัะตะณะธะธ
- ะะธะฝะธะผะฐะปัะฝะฐั ะปะพะณะธะบะฐ, ะธัะฟะพะปัะทัะตััั ะดะปั sanity-check

**ะะฐะฒะธัะธะผะพััะธ:** `strategy_base.py`, `trade_features.py`

---

### `rr_utils.py` โ ะฃัะธะปะธัั ะดะปั RR-ัััะฐัะตะณะธะน

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะฑัะฐั ะปะพะณะธะบะฐ ะดะปั RR ะธ RRD ัััะฐัะตะณะธะน.

**ะัะฝะพะฒะฝัะต ััะฝะบัะธะธ:**
- `apply_tp_sl_logic()` โ ะฟัะธะผะตะฝะตะฝะธะต ะปะพะณะธะบะธ TP/SL
- `find_exit()` โ ะฟะพะธัะบ ัะพัะบะธ ะฒััะพะดะฐ
- `calculate_atr()` โ ัะฐััะตั Average True Range
- `validate_candles()` โ ะฟัะพะฒะตัะบะฐ ะบะฐัะตััะฒะฐ ัะฒะตัะตะน

**ะะฐะฒะธัะธะผะพััะธ:** `models.py`, `warn_dedup.py`

---

### `trade_features.py` โ ะคะธัะธ ัะดะตะปะพะบ

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะฐััะตั ะดะพะฟะพะปะฝะธัะตะปัะฝัั ะผะตััะธะบ ะดะปั ัะดะตะปะพะบ.

**ะัะฝะพะฒะฝัะต ััะฝะบัะธะธ:**
- `calculate_market_cap_proxy()` โ ัะฐััะตั ะฟัะธะฑะปะธะทะธัะตะปัะฝะพะน ะบะฐะฟะธัะฐะปะธะทะฐัะธะธ
- `calculate_volume_features()` โ ะพะฑัะตะผั ะฒ ัะฐะทะฝัั ะฒัะตะผะตะฝะฝัั ะพะบะฝะฐั
- `calculate_volatility_features()` โ ะฒะพะปะฐัะธะปัะฝะพััั ะฒ ัะฐะทะฝัั ะพะบะฝะฐั
- `add_trade_features()` โ ะดะพะฑะฐะฒะปะตะฝะธะต ะฒัะตั ัะธั ะฒ meta

**ะัะพะฑะตะฝะฝะพััะธ:**
- ะคะธัะธ ัะฐัััะธััะฒะฐัััั ัะพะปัะบะพ ะฝะฐ ะดะฐะฝะฝัั ะะ ะฒัะพะดะฐ (ะฑะตะท data leakage)
- ะะตะทัะปััะฐัั ัะพััะฐะฝััััั ะฒ `StrategyOutput.meta`

**ะะฐะฒะธัะธะผะพััะธ:** `models.py`

---

### `position.py` โ ะะพะดะตะปั ะฟะพะทะธัะธะธ

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะัะตะดััะฐะฒะปะตะฝะธะต ะพัะบัััะพะน ะฟะพะทะธัะธะธ ะฒ ะฟะพัััะตะปะต.

**ะัะฝะพะฒะฝัะต ะบะปะฐััั:**
- `Position` โ ะบะปะฐัั ะฟะพะทะธัะธะธ (entry_time, entry_price, size_sol, contract_address, strategy_name)

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต:** ะัะฟะพะปัะทัะตััั ะฒ `portfolio.py` ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั ะพัะบััััั ะฟะพะทะธัะธะน

**ะะฐะฒะธัะธะผะพััะธ:** `models.py`

---

### `portfolio.py` โ ะะพัััะตะปัะฝัะน ะดะฒะธะถะพะบ

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะกะธะผัะปััะธั ะฟะพัััะตะปัะฝะพะน ัะพัะณะพะฒะปะธ ั ััะตัะพะผ ะบะพะผะธััะธะน ะธ ะพะณัะฐะฝะธัะตะฝะธะน.

**ะัะฝะพะฒะฝัะต ะบะปะฐััั:**
- `FeeModel` โ ะผะพะดะตะปั ะบะพะผะธััะธะน (swap_fee_pct, lp_fee_pct, slippage_pct, network_fee_sol)
- `PortfolioConfig` โ ะบะพะฝัะธะณััะฐัะธั ะฟะพัััะตะปั (initial_balance, allocation_mode, limits, fee_model)
- `PortfolioStats` โ ััะฐัะธััะธะบะฐ ะฟะพัััะตะปั (final_balance, total_return, max_drawdown, trades_executed)
- `PortfolioResult` โ ัะตะทัะปััะฐั ัะธะผัะปััะธะธ (equity_curve, positions, stats)
- `PortfolioEngine` โ ะพัะฝะพะฒะฝะพะน ะดะฒะธะถะพะบ ัะธะผัะปััะธะธ

**ะัะฝะพะฒะฝัะต ะผะตัะพะดั:**
- `PortfolioEngine.simulate()` โ ะพัะฝะพะฒะฝะพะน ะผะตัะพะด ัะธะผัะปััะธะธ
- `PortfolioEngine._position_size()` โ ัะฐััะตั ัะฐะทะผะตัะฐ ะฟะพะทะธัะธะธ
- `PortfolioEngine._apply_fees()` โ ะฟัะธะผะตะฝะตะฝะธะต ะบะพะผะธััะธะน
- `FeeModel.effective_fee_pct()` โ ัะฐััะตั ัััะตะบัะธะฒะฝัั ะบะพะผะธััะธะน

**ะัะพะฑะตะฝะฝะพััะธ:**
- ะฃัะตั ะฒัะตั ะบะพะผะธััะธะน (swap, LP, ัะตัั)
- ะะพะดะตะปะธัะพะฒะฐะฝะธะต ะฟัะพัะบะฐะปัะทัะฒะฐะฝะธั
- ะะพัััะตะปัะฝัะต ะพะณัะฐะฝะธัะตะฝะธั (max_exposure, max_open_positions)
- ะะตะถะธะผ Runner-XN Reset (ะทะฐะบัััะธะต ะฒัะตั ะฟะพะทะธัะธะน ะฟัะธ ะดะพััะธะถะตะฝะธะธ XN)

**ะะฐะฒะธัะธะผะพััะธ:** `models.py`, `position.py`

---

## ๐ง Application Layer (ะกะปะพะน ะฟัะธะปะพะถะตะฝะธั)

**ะะฐะทะฝะฐัะตะฝะธะต:** ะัะบะตัััะฐัะธั ัะฐะฑะพัั ัะธััะตะผั, ะบะพะพัะดะธะฝะฐัะธั ะผะตะถะดั ัะปะพัะผะธ.

### `runner.py` โ BacktestRunner

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะปะฐะฒะฝัะน ะพัะบะตัััะฐัะพั ะฑัะบัะตััะฐ.

**ะัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั:**
- `BacktestRunner` โ ะบะปะฐัั ะพัะบะตัััะฐัะพัะฐ

**ะัะฝะพะฒะฝัะต ะผะตัะพะดั:**
- `BacktestRunner.run()` โ ะทะฐะฟััะบ ะพัะฝะพะฒะฝะพะณะพ ะฑัะบัะตััะฐ
  - ะะฐะณััะถะฐะตั ัะธะณะฝะฐะปั
  - ะะปั ะบะฐะถะดะพะณะพ ัะธะณะฝะฐะปะฐ ะทะฐะณััะถะฐะตั ัะฒะตัะธ
  - ะัะธะผะตะฝัะตั ะฒัะต ัััะฐัะตะณะธะธ
  - ะกะพะฑะธัะฐะตั ัะตะทัะปััะฐัั
- `BacktestRunner.run_portfolio()` โ ะทะฐะฟััะบ ะฟะพัััะตะปัะฝะพะน ัะธะผัะปััะธะธ
  - ะคะธะปััััะตั ัะตะทัะปััะฐัั ะฟะพ ัััะฐัะตะณะธัะผ
  - ะะฐะฟััะบะฐะตั PortfolioEngine ะดะปั ะบะฐะถะดะพะน ัััะฐัะตะณะธะธ
- `BacktestRunner._process_signal()` โ ะพะฑัะฐะฑะพัะบะฐ ะพะดะฝะพะณะพ ัะธะณะฝะฐะปะฐ (ะผะพะถะตั ะฒัะทัะฒะฐัััั ะฟะฐัะฐะปะปะตะปัะฝะพ)
- `BacktestRunner._build_portfolio_config()` โ ะฟะพัััะพะตะฝะธะต ะบะพะฝัะธะณััะฐัะธะธ ะฟะพัััะตะปั

**ะัะพะฑะตะฝะฝะพััะธ:**
- ะะพะดะดะตัะถะบะฐ ะฟะฐัะฐะปะปะตะปัะฝะพะน ะพะฑัะฐะฑะพัะบะธ ัะธะณะฝะฐะปะพะฒ (ThreadPoolExecutor)
- ะะฝัะตะณัะฐัะธั ั ะฟะพัััะตะปัะฝัะผ ัะปะพะตะผ
- ะะตะดัะฟะปะธะบะฐัะธั ะฟัะตะดัะฟัะตะถะดะตะฝะธะน ัะตัะตะท WarnDedup

**ะะฐะฒะธัะธะผะพััะธ:**
- `infrastructure.signal_loader` โ ะทะฐะณััะทะบะฐ ัะธะณะฝะฐะปะพะฒ
- `infrastructure.price_loader` โ ะทะฐะณััะทะบะฐ ัะฒะตัะตะน
- `domain.strategy_base` โ ัััะฐัะตะณะธะธ
- `domain.portfolio` โ ะฟะพัััะตะปัะฝัะน ะดะฒะธะถะพะบ
- `utils.warn_dedup` โ ะดะตะดัะฟะปะธะบะฐัะธั ะฟัะตะดัะฟัะตะถะดะตะฝะธะน

---

## ๐ Infrastructure Layer (ะะฝััะฐััััะบัััะฝัะน ัะปะพะน)

**ะะฐะทะฝะฐัะตะฝะธะต:** ะะทะฐะธะผะพะดะตะนััะฒะธะต ั ะฒะฝะตัะฝะธะผ ะผะธัะพะผ (ัะฐะนะปั, API, ะพััะตัั).

### `signal_loader.py` โ ะะฐะณััะทะบะฐ ัะธะณะฝะฐะปะพะฒ

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะฐะณััะทะบะฐ ัะธะณะฝะฐะปะพะฒ ะธะท ัะฐะทะปะธัะฝัั ะธััะพัะฝะธะบะพะฒ.

**ะัะฝะพะฒะฝัะต ะบะปะฐััั:**
- `SignalLoader` (ABC) โ ะฐะฑัััะฐะบัะฝัะน ะฑะฐะทะพะฒัะน ะบะปะฐัั
- `CsvSignalLoader` โ ะทะฐะณััะทะบะฐ ะธะท CSV ัะฐะนะปะพะฒ

**ะัะฝะพะฒะฝัะต ะผะตัะพะดั:**
- `SignalLoader.load_signals()` โ ะฐะฑัััะฐะบัะฝัะน ะผะตัะพะด ะทะฐะณััะทะบะธ
- `CsvSignalLoader.load_signals()` โ ัะตะฐะปะธะทะฐัะธั ะทะฐะณััะทะบะธ ะธะท CSV

**ะัะพะฑะตะฝะฝะพััะธ:**
- ะะฐะปะธะดะฐัะธั ะพะฑัะทะฐัะตะปัะฝัั ะฟะพะปะตะน
- ะะฐััะธะฝะณ timestamp ะฒ UTC
- ะะพะดะดะตัะถะบะฐ extra_json (JSON ะฒ CSV ะบะพะปะพะฝะบะต)

**ะะฐะฒะธัะธะผะพััะธ:** `domain.models` (Signal)

---

### `price_loader.py` โ ะะฐะณััะทะบะฐ ัะฒะตัะตะน

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะฐะณััะทะบะฐ ัะตะฝะพะฒัั ะดะฐะฝะฝัั (ัะฒะตัะตะน) ะธะท ัะฐะทะปะธัะฝัั ะธััะพัะฝะธะบะพะฒ.

**ะัะฝะพะฒะฝัะต ะบะปะฐััั:**
- `PriceLoader` (ABC) โ ะฐะฑัััะฐะบัะฝัะน ะฑะฐะทะพะฒัะน ะบะปะฐัั
- `CsvPriceLoader` โ ะทะฐะณััะทะบะฐ ะธะท ะปะพะบะฐะปัะฝัั CSV ัะฐะนะปะพะฒ
- `GeckoTerminalPriceLoader` โ ะทะฐะณััะทะบะฐ ัะตัะตะท GeckoTerminal API

**ะัะฝะพะฒะฝัะต ะผะตัะพะดั:**
- `PriceLoader.load_prices()` โ ะฐะฑัััะฐะบัะฝัะน ะผะตัะพะด ะทะฐะณััะทะบะธ
- `CsvPriceLoader.load_prices()` โ ัะตะฐะปะธะทะฐัะธั ะทะฐะณััะทะบะธ ะธะท CSV
- `GeckoTerminalPriceLoader.load_prices()` โ ัะตะฐะปะธะทะฐัะธั ะทะฐะณััะทะบะธ ัะตัะตะท API

**ะัะพะฑะตะฝะฝะพััะธ CsvPriceLoader:**
- ะคะธะปัััะฐัะธั ะฟะพ ะฒัะตะผะตะฝะฝะพะผั ะพะบะฝั
- ะะฐะปะธะดะฐัะธั ะดะฐะฝะฝัั ัะฒะตัะตะน
- ะกะพััะธัะพะฒะบะฐ ะฟะพ timestamp

**ะัะพะฑะตะฝะฝะพััะธ GeckoTerminalPriceLoader:**
- ะะตัะธัะพะฒะฐะฝะธะต ะดะฐะฝะฝัั ะฒ ะปะพะบะฐะปัะฝัะต CSV
- ะะฐะณะธะฝะฐัะธั ะดะปั ะธััะพัะธัะตัะบะธั ะดะฐะฝะฝัั
- Retry-ะปะพะณะธะบะฐ ั ัะบัะฟะพะฝะตะฝัะธะฐะปัะฝะพะน ะทะฐะดะตัะถะบะพะน
- Rate limiting (30 ะทะฐะฟัะพัะพะฒ/ะผะธะฝััั)
- ะฃะผะฝะพะต ะบะตัะธัะพะฒะฐะฝะธะต (ะฟัะพะฒะตัะบะฐ ะฟะพะบัััะธั ะดะธะฐะฟะฐะทะพะฝะฐ)
- Fallback ะฝะฐ ะบะตั ะฟัะธ ะพัะธะฑะบะฐั API
- ะัะฑะพั ะฟัะปะฐ ั ะฝะฐะธะฑะพะปััะตะน ะปะธะบะฒะธะดะฝะพัััั

**ะะฐะฒะธัะธะผะพััะธ:** `domain.models` (Candle)

---

### `reporter.py` โ ะะตะฝะตัะฐัะธั ะพััะตัะพะฒ

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะตะฝะตัะฐัะธั ัะฐะทะปะธัะฝัั ัะธะฟะพะฒ ะพััะตัะพะฒ ะฟะพ ัะตะทัะปััะฐัะฐะผ ะฑัะบัะตััะฐ.

**ะัะฝะพะฒะฝัะต ะบะปะฐััั:**
- `Reporter` โ ะบะปะฐัั ะดะปั ะณะตะฝะตัะฐัะธะธ ะพััะตัะพะฒ

**ะัะฝะพะฒะฝัะต ะผะตัะพะดั:**
- `Reporter.generate_full_report()` โ ะณะตะฝะตัะฐัะธั ะฟะพะปะฝะพะณะพ ะพััะตัะฐ (JSON, CSV, HTML)
- `Reporter.save_trades_table()` โ ัะพััะฐะฝะตะฝะธะต ะตะดะธะฝะพะน ัะฐะฑะปะธัั ัะดะตะปะพะบ
- `Reporter.save_portfolio_results()` โ ัะพััะฐะฝะตะฝะธะต ะฟะพัััะตะปัะฝัั ัะตะทัะปััะฐัะพะฒ
- `Reporter._calculate_metrics()` โ ัะฐััะตั ะผะตััะธะบ (winrate, Sharpe, drawdown, profit factor)
- `Reporter._generate_charts()` โ ะณะตะฝะตัะฐัะธั ะณัะฐัะธะบะพะฒ (equity curve, PnL distribution, exit reasons)

**ะะตะฝะตัะธััะตะผัะต ะผะตััะธะบะธ:**
- Winrate
- Sharpe ratio (ะณะพะดะพะฒะฐั)
- Max drawdown
- Profit factor
- ะกัะตะดะฝัั/ะผะตะดะธะฐะฝะฝะฐั PnL
- ะะฐัะฟัะตะดะตะปะตะฝะธะต ะฟะพ ะธััะพัะฝะธะบะฐะผ ัะธะณะฝะฐะปะพะฒ
- ะะฐัะฟัะตะดะตะปะตะฝะธะต ะฟะพ ะฟัะธัะธะฝะฐะผ ะฒััะพะดะฐ

**ะคะพัะผะฐั ะพััะตัะพะฒ:**
- JSON โ ััััะบัััะธัะพะฒะฐะฝะฝัะต ะดะฐะฝะฝัะต
- CSV โ ัะฐะฑะปะธัะฝัะต ะดะฐะฝะฝัะต
- HTML โ ะฒะธะทัะฐะปะธะทะฐัะธั ั ะณัะฐัะธะบะฐะผะธ (matplotlib)

**ะะฐะฒะธัะธะผะพััะธ:** `domain.models`, `matplotlib`, `pandas`, `numpy`

---

## ๐ฌ Research Layer (ะััะปะตะดะพะฒะฐัะตะปััะบะธะน ัะปะพะน)

**ะะฐะทะฝะฐัะตะฝะธะต:** ะะฝะฐะปะธะท ัััะพะนัะธะฒะพััะธ ัััะฐัะตะณะธะน ะธ ะธััะปะตะดะพะฒะฐัะตะปััะบะฐั ะฐะฝะฐะปะธัะธะบะฐ.

### `window_aggregator.py` โ ะะณัะตะณะฐัะธั ะฟะพ ะพะบะฝะฐะผ

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะฐะทะฑะธะตะฝะธะต ัะดะตะปะพะบ ะฝะฐ ะฒัะตะผะตะฝะฝัะต ะพะบะฝะฐ ะธ ัะฐััะตั ะผะตััะธะบ ะดะปั ะบะฐะถะดะพะณะพ ะพะบะฝะฐ.

**ะัะฝะพะฒะฝัะต ััะฝะบัะธะธ:**
- `load_trades_csv()` โ ะทะฐะณััะทะบะฐ ัะฐะฑะปะธัั ัะดะตะปะพะบ ะธะท CSV
- `calculate_window_metrics()` โ ัะฐััะตั ะผะตััะธะบ ะดะปั ะพะบะฝะฐ ัะดะตะปะพะบ
- `aggregate_strategy_by_equal_windows()` โ ะฐะณัะตะณะฐัะธั ัััะฐัะตะณะธะธ ะฟะพ ัะฐะฒะฝัะผ ะพะบะฝะฐะผ
- `aggregate_all_strategies()` โ ะฐะณัะตะณะฐัะธั ะฒัะตั ัััะฐัะตะณะธะน

**ะัะพะฑะตะฝะฝะพััะธ:**
- ะะพะดะดะตัะถะบะฐ ัะฐะฒะฝัั ะฒัะตะผะตะฝะฝัั ะพะบะพะฝ (2, 3, 4, 5 ัะฐััะตะน)
- ะะฐััะตั ะผะตััะธะบ ะดะปั ะบะฐะถะดะพะณะพ ะพะบะฝะฐ (winrate, total_pnl, median_pnl, max_drawdown, profit_factor)
- ะกะพััะฐะฝะตะฝะธะต ะดะตัะฐะปัะฝะพะน ัะฐะฑะปะธัั ะฒัะตั ะพะบะพะฝ

**ะะฐะฒะธัะธะผะพััะธ:** `pandas`, `numpy`, `statistics`

---

### `strategy_stability.py` โ ะะฝะฐะปะธะท ัััะพะนัะธะฒะพััะธ

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะฐััะตั ะผะตััะธะบ ัััะพะนัะธะฒะพััะธ ัััะฐัะตะณะธะน.

**ะัะฝะพะฒะฝัะต ััะฝะบัะธะธ:**
- `calculate_stability_metrics()` โ ัะฐััะตั ะผะตััะธะบ ัััะพะนัะธะฒะพััะธ ะดะปั ะพะดะฝะพะน ัััะฐัะตะณะธะธ
- `build_stability_table()` โ ะฟะพัััะพะตะฝะธะต ัะฐะฑะปะธัั ัััะพะนัะธะฒะพััะธ ะดะปั ะฒัะตั ัััะฐัะตะณะธะน
- `generate_stability_table_from_reports()` โ ะณะตะฝะตัะฐัะธั ัะฐะฑะปะธัั ะธะท ัะฐะนะปะพะฒ trades.csv

**ะะตััะธะบะธ ัััะพะนัะธะฒะพััะธ:**
- `survival_rate` โ ะดะพะปั ะฟัะธะฑัะปัะฝัั ะพะบะพะฝ (0.0 - 1.0)
- `worst_window_pnl` โ ััะดัะธะน PnL ััะตะดะธ ะฒัะตั ะพะบะพะฝ
- `median_window_pnl` โ ะผะตะดะธะฐะฝะฝัะน PnL ะพะบะพะฝ
- `pnl_variance` โ ะดะธัะฟะตััะธั PnL ะพะบะพะฝ
- `windows_total` โ ะพะฑัะตะต ะบะพะปะธัะตััะฒะพ ะพะบะพะฝ

**ะััะพะดะฝัะต ะดะฐะฝะฝัะต:**
- `strategy_stability.csv` โ ัะฐะฑะปะธัะฐ ัััะพะนัะธะฒะพััะธ ะฒัะตั ัััะฐัะตะณะธะน
- `stage_a_summary.csv` โ ะดะตัะฐะปัะฝะฐั ัะฐะฑะปะธัะฐ ัะพ ะฒัะตะผะธ ะพะบะฝะฐะผะธ

**ะะฐะฒะธัะธะผะพััะธ:** `window_aggregator.py`, `pandas`

---

### `run_stage_a.py` โ CLI ะดะปั Stage A

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะขะพัะบะฐ ะฒัะพะดะฐ ะดะปั ะทะฐะฟััะบะฐ ะฐะฝะฐะปะธะทะฐ ัััะพะนัะธะฒะพััะธ.

**ะัะฝะพะฒะฝัะต ััะฝะบัะธะธ:**
- `main()` โ ะณะปะฐะฒะฝะฐั ััะฝะบัะธั CLI
- `format_summary()` โ ัะพัะผะฐัะธัะพะฒะฐะฝะธะต ะบัะฐัะบะพะณะพ summary

**ะะฐัะฐะผะตััั ะบะพะผะฐะฝะดะฝะพะน ัััะพะบะธ:**
- `--reports-dir` โ ะดะธัะตะบัะพัะธั ั ัะฐะนะปะฐะผะธ trades.csv
- `--splits` โ ัะฟะธัะพะบ ะบะพะปะธัะตััะฒ ัะฐะทะฑะธะตะฝะธะน (2, 3, 4, 5)

**ะะฐะฒะธัะธะผะพััะธ:** `window_aggregator.py`, `strategy_stability.py`

---

## โ Decision Layer (ะกะปะพะน ะฟัะธะฝััะธั ัะตัะตะฝะธะน)

**ะะฐะทะฝะฐัะตะฝะธะต:** ะะฒัะพะผะฐัะธัะตัะบะธะน ะพัะฑะพั ัััะฐัะตะณะธะน ะฝะฐ ะพัะฝะพะฒะต ะบัะธัะตัะธะตะฒ.

### `selection_rules.py` โ ะัะฐะฒะธะปะฐ ะพัะฑะพัะฐ

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะฟัะตะดะตะปะตะฝะธะต ะบัะธัะตัะธะตะฒ ะพัะฑะพัะฐ ัััะฐัะตะณะธะน.

**ะัะฝะพะฒะฝัะต ะบะปะฐััั:**
- `SelectionCriteria` โ ะบะปะฐัั ะบัะธัะตัะธะตะฒ ะพัะฑะพัะฐ

**ะัะธัะตัะธะธ (ะฟะพ ัะผะพะปัะฐะฝะธั):**
- `min_survival_rate = 0.5` โ ะผะธะฝะธะผัะผ 50% ะพะบะพะฝ ะดะพะปะถะฝั ะฑััั ะฟัะธะฑัะปัะฝัะผะธ
- `max_pnl_variance = 0.1` โ ะผะฐะบัะธะผะฐะปัะฝะฐั ะดะธัะฟะตััะธั PnL
- `min_worst_window_pnl = -0.2` โ ะผะธะฝะธะผัะผ ััะดัะตะณะพ ะพะบะฝะฐ (ะฝะต ะฑะพะปะตะต 20% ะฟะพัะตัั)
- `min_median_window_pnl = 0.0` โ ะผะธะฝะธะผัะผ ะผะตะดะธะฐะฝะฝะพะณะพ PnL (ะฝะตะพััะธัะฐัะตะปัะฝัะน)
- `min_windows = 4` โ ะผะธะฝะธะผัะผ ะพะบะพะฝ ะดะปั ััะฐัะธััะธัะตัะบะพะน ะทะฝะฐัะธะผะพััะธ

**ะะฐะฒะธัะธะผะพััะธ:** ะขะพะปัะบะพ ััะฐะฝะดะฐััะฝะฐั ะฑะธะฑะปะธะพัะตะบะฐ Python (dataclasses)

---

### `strategy_selector.py` โ ะะพะณะธะบะฐ ะพัะฑะพัะฐ

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะัะธะผะตะฝะตะฝะธะต ะบัะธัะตัะธะตะฒ ะพัะฑะพัะฐ ะบ ัััะฐัะตะณะธัะผ.

**ะัะฝะพะฒะฝัะต ััะฝะบัะธะธ:**
- `check_strategy_criteria()` โ ะฟัะพะฒะตัะบะฐ ัััะฐัะตะณะธะธ ะฟะพ ะบัะธัะตัะธัะผ
- `select_strategies()` โ ะพัะฑะพั ัััะฐัะตะณะธะน ะธะท ัะฐะฑะปะธัั ัััะพะนัะธะฒะพััะธ
- `generate_selection_table_from_stability()` โ ะณะตะฝะตัะฐัะธั ัะฐะฑะปะธัั ะพัะฑะพัะฐ ะธะท CSV
- `load_stability_csv()` โ ะทะฐะณััะทะบะฐ ัะฐะฑะปะธัั ัััะพะนัะธะฒะพััะธ

**ะะพะณะธะบะฐ ะพัะฑะพัะฐ:**
- ะกััะฐัะตะณะธั ะฟัะพัะพะดะธั, ะตัะปะธ **ะะกะ** ะบัะธัะตัะธะธ ะฒัะฟะพะปะฝะตะฝั
- ะะปั ะฝะตะฟัะพัะตะดัะธั ัััะฐัะตะณะธะน ัะธะบัะธัััััั ะฟัะธัะธะฝั ะพัะบะปะพะฝะตะฝะธั

**ะััะพะดะฝัะต ะดะฐะฝะฝัะต:**
- `strategy_selection.csv` โ ัะฐะฑะปะธัะฐ ะพัะฑะพัะฐ ัะพ ะฒัะตะผะธ ัััะฐัะตะณะธัะผะธ ะธ ัะตะทัะปััะฐัะฐะผะธ ะฟัะพะฒะตัะบะธ

**ะะฐะฒะธัะธะผะพััะธ:** `selection_rules.py`, `pandas`

---

### `run_stage_b.py` โ CLI ะดะปั Stage B

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะขะพัะบะฐ ะฒัะพะดะฐ ะดะปั ะทะฐะฟััะบะฐ ะพัะฑะพัะฐ ัััะฐัะตะณะธะน.

**ะัะฝะพะฒะฝัะต ััะฝะบัะธะธ:**
- `main()` โ ะณะปะฐะฒะฝะฐั ััะฝะบัะธั CLI
- `format_selection_summary()` โ ัะพัะผะฐัะธัะพะฒะฐะฝะธะต ะบัะฐัะบะพะณะพ summary

**ะะฐัะฐะผะตััั ะบะพะผะฐะฝะดะฝะพะน ัััะพะบะธ:**
- `--stability-csv` โ ะฟััั ะบ ัะฐะนะปั strategy_stability.csv
- `--output-csv` โ ะฟััั ะดะปั ัะพััะฐะฝะตะฝะธั ัะตะทัะปััะฐัะพะฒ

**ะะฐะฒะธัะธะผะพััะธ:** `strategy_selector.py`, `selection_rules.py`

---

## ๐๏ธ Utils Layer (ะฃัะธะปะธัั)

**ะะฐะทะฝะฐัะตะฝะธะต:** ะัะฟะพะผะพะณะฐัะตะปัะฝัะต ััะฝะบัะธะธ ะพะฑัะตะณะพ ะฝะฐะทะฝะฐัะตะฝะธั.

### `warn_dedup.py` โ ะะตะดัะฟะปะธะบะฐัะธั ะฟัะตะดัะฟัะตะถะดะตะฝะธะน

**ะัะฒะตัััะฒะตะฝะฝะพััั:** ะะพัะพะบะพะฑะตะทะพะฟะฐัะฝะฐั ะดะตะดัะฟะปะธะบะฐัะธั ะฟะพะฒัะพััััะธััั ะฟัะตะดัะฟัะตะถะดะตะฝะธะน.

**ะัะฝะพะฒะฝัะต ะบะปะฐััั:**
- `WarnDedup` โ ะบะปะฐัั ะดะปั ะดะตะดัะฟะปะธะบะฐัะธะธ

**ะัะพะฑะตะฝะฝะพััะธ:**
- ะะพัะพะบะพะฑะตะทะพะฟะฐัะฝะพััั (thread-safe)
- ะะณัะฐะฝะธัะตะฝะธะต ะบะพะปะธัะตััะฒะฐ ะฒัะฒะพะดะพะฒ ะพะดะธะฝะฐะบะพะฒัั ะฟัะตะดัะฟัะตะถะดะตะฝะธะน
- ะะพะดะดะตัะถะบะฐ summary ััะฐัะธััะธะบะธ

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต:** ะัะฟะพะปัะทัะตััั ะฒ ัััะฐัะตะณะธัั ะธ ะดััะณะธั ะผะพะดัะปัั ะดะปั ัะผะตะฝััะตะฝะธั ััะผะฐ ะฒ ะปะพะณะฐั

**ะะฐะฒะธัะธะผะพััะธ:** ะขะพะปัะบะพ ััะฐะฝะดะฐััะฝะฐั ะฑะธะฑะปะธะพัะตะบะฐ Python (threading, collections)

---

## ๐ ะกัะตะผะฐ ะทะฐะฒะธัะธะผะพััะตะน

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Infrastructure Layer                      โ
โ  signal_loader  โ  price_loader  โ  reporter                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Application Layer                         โ
โ                      runner.py                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      Domain Layer                            โ
โ  models โ strategy_base โ rr_strategy โ rrd_strategy โ ...  โ
โ  portfolio โ position โ trade_features โ rr_utils            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Research Layer                            โ
โ  window_aggregator โ strategy_stability โ run_stage_a        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Decision Layer                            โ
โ  selection_rules โ strategy_selector โ run_stage_b          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      Utils Layer                             โ
โ                        warn_dedup                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ะะพัะพะบะธ ะดะฐะฝะฝัั

### ะัะฝะพะฒะฝะพะน ะฑัะบัะตัั

```
Signals (CSV)
    โ
CsvSignalLoader
    โ
List[Signal]
    โ
BacktestRunner.run()
    โ
For each Signal:
    PriceLoader.load_prices()
        โ
    List[Candle]
        โ
    StrategyInput
        โ
    Strategy.on_signal()
        โ
    StrategyOutput
        โ
List[Results]
    โ
Reporter.generate_full_report()
    โ
Reports (JSON, CSV, HTML)
```

### ะะพัััะตะปัะฝะฐั ัะธะผัะปััะธั

```
List[Results]
    โ
PortfolioEngine.simulate()
    โ
Filter by strategy
    โ
Apply portfolio constraints
    โ
Calculate fees
    โ
PortfolioResult
    โ
Reporter.save_portfolio_results()
    โ
Portfolio Reports
```

### Stage A (ะฃััะพะนัะธะฒะพััั)

```
{strategy}_trades.csv
    โ
window_aggregator.load_trades_csv()
    โ
aggregate_all_strategies()
    โ
Split into windows (2, 3, 4, 5)
    โ
Calculate metrics per window
    โ
strategy_stability.build_stability_table()
    โ
strategy_stability.csv
```

### Stage B (ะัะฑะพั)

```
strategy_stability.csv
    โ
strategy_selector.load_stability_csv()
    โ
select_strategies()
    โ
Apply SelectionCriteria
    โ
Check each criterion
    โ
strategy_selection.csv (with passed/failed)
```

---

## ๐ฏ ะัะฒะตัััะฒะตะฝะฝะพััั ะผะพะดัะปะตะน (ะบัะฐัะบะพะต ัะตะทัะผะต)

| ะะพะดัะปั | ะัะฒะตัััะฒะตะฝะฝะพััั |
|--------|----------------|
| `domain/models.py` | ะะฟัะตะดะตะปะตะฝะธะต ััััะบััั ะดะฐะฝะฝัั |
| `domain/strategy_base.py` | ะะฝัะตััะตะนั ัััะฐัะตะณะธะน |
| `domain/rr_strategy.py` | RR ัััะฐัะตะณะธั |
| `domain/rrd_strategy.py` | RRD ัััะฐัะตะณะธั |
| `domain/runner_strategy.py` | Runner ัััะฐัะตะณะธั |
| `domain/rr_utils.py` | ะะฑัะฐั ะปะพะณะธะบะฐ RR/RRD |
| `domain/trade_features.py` | ะะฐััะตั ัะธั ัะดะตะปะพะบ |
| `domain/position.py` | ะะพะดะตะปั ะฟะพะทะธัะธะธ |
| `domain/portfolio.py` | ะะพัััะตะปัะฝะฐั ัะธะผัะปััะธั |
| `application/runner.py` | ะัะบะตัััะฐัะธั ะฑัะบัะตััะฐ |
| `infrastructure/signal_loader.py` | ะะฐะณััะทะบะฐ ัะธะณะฝะฐะปะพะฒ |
| `infrastructure/price_loader.py` | ะะฐะณััะทะบะฐ ัะฒะตัะตะน |
| `infrastructure/reporter.py` | ะะตะฝะตัะฐัะธั ะพััะตัะพะฒ |
| `research/window_aggregator.py` | ะะณัะตะณะฐัะธั ะฟะพ ะพะบะฝะฐะผ |
| `research/strategy_stability.py` | ะะตััะธะบะธ ัััะพะนัะธะฒะพััะธ |
| `research/run_stage_a.py` | CLI Stage A |
| `decision/selection_rules.py` | ะัะธัะตัะธะธ ะพัะฑะพัะฐ |
| `decision/strategy_selector.py` | ะะพะณะธะบะฐ ะพัะฑะพัะฐ |
| `decision/run_stage_b.py` | CLI Stage B |
| `utils/warn_dedup.py` | ะะตะดัะฟะปะธะบะฐัะธั ะฟัะตะดัะฟัะตะถะดะตะฝะธะน |

---

## ๐ ะะพะฟะพะปะฝะธัะตะปัะฝัะต ัะตััััั

- **PRODUCT_ANALYSIS.md** โ ะฟัะพะดัะบัะพะฒัะน ะฐะฝะฐะปะธะท
- **TECHNICAL_REPORT.md** โ ัะตัะฝะธัะตัะบะธะน ะพััะตั
- **PIPELINE_GUIDE.md** โ ััะบะพะฒะพะดััะฒะพ ะฟะพ ะฟะฐะนะฟะปะฐะนะฝั
- **PORTFOLIO_LAYER.md** โ ะดะตัะฐะปะธ ะฟะพัััะตะปัะฝะพะณะพ ัะปะพั

---

*ะะพะบัะผะตะฝั ะพะฑะฝะพะฒะปะตะฝ: 2025-12-14*

