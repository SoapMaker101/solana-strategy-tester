# –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

**–í–µ—Ä—Å–∏—è:** 2.0  
**–î–∞—Ç–∞:** 2025-01-XX  
**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** –î–æ–±–∞–≤–ª–µ–Ω—ã Stage B –∫—Ä–∏—Ç–µ—Ä–∏–∏ –∏ portfolio-level reset

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏](#–æ–±–∑–æ—Ä-runner-—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –º–æ–¥—É–ª–∏](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∏-–º–æ–¥—É–ª–∏)
3. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
4. [Workflow: –æ—Ç research –¥–æ –æ—Ç–±–æ—Ä–∞](#workflow-–æ—Ç-research-–¥–æ-–æ—Ç–±–æ—Ä–∞)
5. [Portfolio-Level Reset](#portfolio-level-reset)
6. [Stage A/B –¥–ª—è Runner](#stage-ab-–¥–ª—è-runner)
7. [Baseline –ø–∞—Ä–∞–º–µ—Ç—Ä—ã](#baseline-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
8. [–ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏](#—á–µ–∫-–ª–∏—Å—Ç-–ø—Ä–æ–≤–µ—Ä–∫–∏)

---

## –û–±–∑–æ—Ä Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

### –ß—Ç–æ —Ç–∞–∫–æ–µ Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏—è?

Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏—è ‚Äî —ç—Ç–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Å **–ª–µ—Å—Ç–Ω–∏—Ü–µ–π —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–æ–≤ (ladder strategy)**, –∫–æ—Ç–æ—Ä–∞—è:

1. **–í—Ö–æ–¥–∏—Ç –≤ –ø–æ–∑–∏—Ü–∏—é** –Ω–∞ –ø–µ—Ä–≤–æ–π —Å–≤–µ—á–µ –ø–æ—Å–ª–µ —Å–∏–≥–Ω–∞–ª–∞
2. **–£–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é** –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 14-21 –¥–µ–Ω—å)
3. **–ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é** –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω—è—Ö –ø—Ä–∏–±—ã–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 40% –Ω–∞ 2x, 40% –Ω–∞ 5x, 20% –Ω–∞ 10x)
4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫** –ø–æ time_stop (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω)

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- ‚úÖ **–ù–µ—Å–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π TP:** –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —á–∞—Å—Ç—è–º–∏ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω—è—Ö (x2, x5, x10)
- ‚úÖ **–ß–∞—Å—Ç–∏—á–Ω—ã–µ –≤—ã—Ö–æ–¥—ã:** –ö–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –¥–æ–ª—é –ø–æ–∑–∏—Ü–∏–∏
- ‚úÖ **Time stop:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –æ—Å—Ç–∞—Ç–∫–∞ —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
- ‚úÖ **Portfolio-level reset:** –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ equity
- ‚úÖ **Stage B –∫—Ä–∏—Ç–µ—Ä–∏–∏:** –û—Ç–¥–µ–ª—å–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ç–±–æ—Ä–∞ –¥–ª—è Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

### –û—Ç–ª–∏—á–∏—è –æ—Ç RR/RRD —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | RR/RRD | Runner |
|----------------|--------|--------|
| –í—ã—Ö–æ–¥ | –ü–æ–ª–Ω—ã–π –≤—ã—Ö–æ–¥ –ø–æ TP/SL | –ß–∞—Å—Ç–∏—á–Ω—ã–µ –≤—ã—Ö–æ–¥—ã –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω—è—Ö |
| –í—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è | –ö–æ—Ä–æ—Ç–∫–æ–µ (—á–∞—Å—ã-–¥–Ω–∏) | –î–ª–∏—Ç–µ–ª—å–Ω–æ–µ (–¥–Ω–∏-–Ω–µ–¥–µ–ª–∏) |
| –ú–µ—Ç—Ä–∏–∫–∏ Stage B | survival_rate, variance | hit_rate_x2, hit_rate_x5, tail_contribution |
| Reset –ª–æ–≥–∏–∫–∞ | –ù–µ—Ç | Portfolio-level reset –ø–æ equity |

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –º–æ–¥—É–ª–∏

### Core Domain Layer

#### `runner_config.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.

**–ö–ª–∞—Å—Å—ã:**
- `RunnerTakeProfitLevel`: –£—Ä–æ–≤–µ–Ω—å TP (xn, fraction)
- `RunnerConfig`: –ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Runner (–Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç `StrategyConfig`)

#### `runner_ladder.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ù–µ–∑–∞–≤–∏—Å–∏–º–∞—è core-–ª–æ–≥–∏–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏ Runner Ladder.

**–ö–ª–∞—Å—Å—ã:**
- `RunnerLadderEngine`: –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–ª–∞—Å—Å —Å –º–µ—Ç–æ–¥–æ–º `simulate()`
- `RunnerTradeResult`: –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–º—É–ª—è—Ü–∏–∏ –æ–¥–Ω–æ–π —Å–¥–µ–ª–∫–∏

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç PortfolioEngine
- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å —Ü–µ–Ω–∞–º–∏ –∏ –≤—Ä–µ–º–µ–Ω–µ–º
- –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏/slippage

#### `runner_strategy.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–¥–∞–ø—Ç–µ—Ä –º–µ–∂–¥—É `RunnerLadderEngine` –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º `Strategy`.

**–ú–µ—Ç–æ–¥—ã:**
- `on_signal()`: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç `StrategyInput`, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `StrategyOutput`
- `_candles_to_dataframe()`: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è `List[Candle]` ‚Üí `pd.DataFrame`
- `_ladder_result_to_strategy_output()`: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è `RunnerTradeResult` ‚Üí `StrategyOutput`

#### `portfolio.py` (Runner –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ Runner –ø–æ–∑–∏—Ü–∏–π –≤ –ø–æ—Ä—Ç—Ñ–µ–ª–µ.

**–ú–µ—Ç–æ–¥—ã:**
- `_process_runner_partial_exits()`: –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞—Å—Ç–∏—á–Ω—ã—Ö –≤—ã—Ö–æ–¥–æ–≤
- Portfolio-level reset –ª–æ–≥–∏–∫–∞

### Research Layer

#### `xn_analysis/` –º–æ–¥—É–ª–∏
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ —Ä–æ—Å—Ç–∞ —Å–∏–≥–Ω–∞–ª–æ–≤.

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- `xn_per_signal.csv`: –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫–∞–∂–¥–æ–º—É —Å–∏–≥–Ω–∞–ª—É
- `xn_summary.csv`: –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ XN-—É—Ä–æ–≤–Ω—è–º

#### `strategy_stability.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í—ã—á–∏—Å–ª–µ–Ω–∏–µ Runner-–º–µ—Ç—Ä–∏–∫ –¥–ª—è Stage A.

**–ú–µ—Ç—Ä–∏–∫–∏:**
- `hit_rate_x2`, `hit_rate_x5`
- `p90_hold_days`
- `tail_contribution`
- `max_drawdown_pct`

### Decision Layer

#### `selection_rules.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –æ—Ç–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π.

**`DEFAULT_RUNNER_CRITERIA`:**
- `min_hit_rate_x2: 0.30`
- `min_hit_rate_x5: 0.10`
- `min_tail_contribution: 0.3`
- `max_drawdown_pct: -0.5`

#### `strategy_selector.py`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –æ—Ç–±–æ—Ä–∞ –∫ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º.

**–õ–æ–≥–∏–∫–∞:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- –£—Å–ª–æ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ (Runner vs RR/RRD)

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (strategies_example.yaml)

```yaml
- name: Runner_Baseline
  type: RUNNER
  params:
    take_profit_levels:
      - { xn: 2.0, fraction: 0.4 }   # 40% –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ 2x
      - { xn: 5.0, fraction: 0.4 }   # 40% –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ 5x
      - { xn: 10.0, fraction: 0.2 }  # 20% –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ 10x
    time_stop_minutes: 20160  # 14 –¥–Ω–µ–π (20160 –º–∏–Ω—É—Ç = 14 * 24 * 60)
    use_high_for_targets: true  # –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ HIGH –∫–∞–∫ —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è TP
    exit_on_first_tp: false  # –ù–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –≤—Å—é –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –ø–µ—Ä–≤–æ–º TP
    allow_partial_fills: true  # –†–∞–∑—Ä–µ—à–∏—Ç—å —á–∞—Å—Ç–∏—á–Ω—ã–µ —Ñ–∏–∫—Å–∞—Ü–∏–∏
```

### Portfolio-level reset (backtest_example.yaml)

```yaml
portfolio:
  runner_reset_enabled: true      # –í–∫–ª—é—á–∏—Ç—å portfolio-level reset
  runner_reset_multiple: 2.0      # –ü–æ—Ä–æ–≥: equity >= cycle_start_equity * 2.0
```

**–õ–æ–≥–∏–∫–∞:**
- –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞: `equity >= cycle_start_equity * runner_reset_multiple`
- –ó–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `cycle_start_equity = new equity`
- –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π —Ü–∏–∫–ª

---

## Workflow: –æ—Ç research –¥–æ –æ—Ç–±–æ—Ä–∞

### –®–∞–≥ 1: XN Analysis (Research)

```bash
python -m backtester.research.xn_analysis.xn_runner \
  --signals signals/example_signals.csv \
  --holding-days 90 \
  --output-dir output/xn_analysis/
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `xn_summary.csv` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–æ–π % —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç x2, x5, x10.

### –®–∞–≥ 2: –í—ã–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ Runner

–ù–∞ –æ—Å–Ω–æ–≤–µ XN-–∞–Ω–∞–ª–∏–∑–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (—Å–º. [Baseline –ø–∞—Ä–∞–º–µ—Ç—Ä—ã](#baseline-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã)).

### –®–∞–≥ 3: –ó–∞–ø—É—Å–∫ –±—ç–∫—Ç–µ—Å—Ç–∞

```bash
python main.py \
  --signals signals/example_signals.csv \
  --strategies-config config/strategies_example.yaml \
  --backtest-config config/backtest_example.yaml
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `*_trades.csv` —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ Runner (levels_hit, fractions_exited, realized_multiple)
- `portfolio_summary.csv` —Å Runner –º–µ—Ç—Ä–∏–∫–∞–º–∏ (reset_count, cycle_start_equity, equity_peak_in_cycle)

### –®–∞–≥ 4: Stage A (Aggregation)

```bash
python -m backtester.research.run_stage_a \
  --reports-dir output/reports/
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `strategy_stability.csv` —Å Runner –º–µ—Ç—Ä–∏–∫–∞–º–∏:
- `hit_rate_x2`, `hit_rate_x5`
- `p90_hold_days`
- `tail_contribution`
- `max_drawdown_pct`

### –®–∞–≥ 5: Stage B (Selection)

```bash
python -m backtester.decision.run_stage_b \
  --stability-csv output/reports/strategy_stability.csv
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `strategy_selection.csv` —Å —Ñ–ª–∞–≥–æ–º `passed` –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.

---

## Portfolio-Level Reset

### –û–ø–∏—Å–∞–Ω–∏–µ

Portfolio-level reset ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º –ø–æ—Ä–æ–≥–∞ equity.

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä–æ–≥–∞:** –ü–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∫–∞–∂–¥–æ–π —Å–¥–µ–ª–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:
   ```python
   equity = balance + sum(p.size for p in open_positions)
   if equity >= cycle_start_equity * runner_reset_multiple:
       # –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏
   ```

2. **–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π:** –í—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–µ (—á–µ—Ä–µ–∑ ExecutionModel)

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–∏–∫–ª–∞:**
   - `cycle_start_equity = new equity` (–ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π)
   - `equity_peak_in_cycle = cycle_start_equity` (—Å–±—Ä–æ—Å –ø–∏–∫–∞)
   - `reset_count++`
   - `last_reset_time = current_time`

4. **–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–æ–≤:** –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `reset_until` –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ö–æ–¥–æ–≤ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∏–≥–Ω–∞–ª–∞

### –ú–µ—Ç—Ä–∏–∫–∏

**–í `PortfolioStats`:**
- `reset_count: int` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π reset
- `last_reset_time: Optional[datetime]` ‚Äî –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ reset
- `cycle_start_equity: float` ‚Äî equity –≤ –Ω–∞—á–∞–ª–µ —Ç–µ–∫—É—â–µ–≥–æ —Ü–∏–∫–ª–∞
- `equity_peak_in_cycle: float` ‚Äî –ø–∏–∫ equity –≤ —Ç–µ–∫—É—â–µ–º —Ü–∏–∫–ª–µ

**–í `portfolio_summary.csv`:**
- –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ `PortfolioStats` —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ CSV

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```yaml
# config/backtest_example.yaml
portfolio:
  runner_reset_enabled: true
  runner_reset_multiple: 2.0  # –ü–æ—Ä–æ–≥: x2 –æ—Ç cycle_start_equity
```

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: 10.0 SOL
- `cycle_start_equity = 10.0`
- –ü–æ—Ä–æ–≥: `10.0 * 2.0 = 20.0 SOL`
- –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ equity >= 20.0 SOL –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è
- –ù–æ–≤—ã–π —Ü–∏–∫–ª –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `cycle_start_equity = 20.0`

---

## Stage A/B –¥–ª—è Runner

### Stage A: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ Runner –º–µ—Ç—Ä–∏–∫

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏–π:**
- `hit_rate_x2`: –î–æ–ª—è —Å–¥–µ–ª–æ–∫, –¥–æ—Å—Ç–∏–≥—à–∏—Ö x2 (–∏–∑ `levels_hit` –≤ meta)
- `hit_rate_x5`: –î–æ–ª—è —Å–¥–µ–ª–æ–∫, –¥–æ—Å—Ç–∏–≥—à–∏—Ö x5 (–∏–∑ `levels_hit` –≤ meta)
- `p90_hold_days`: 90-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å –≤—Ä–µ–º–µ–Ω–∏ —É–¥–µ—Ä–∂–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
- `tail_contribution`: –î–æ–ª—è PnL –æ—Ç top 5% —Å–¥–µ–ª–æ–∫
- `max_drawdown_pct`: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞ –∏–∑ `portfolio_summary.csv`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `strategy_stability.csv` —Å–æ–¥–µ—Ä–∂–∏—Ç Runner –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏–π.

### Stage B: –û—Ç–±–æ—Ä –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º

**Baseline –∫—Ä–∏—Ç–µ—Ä–∏–∏ (`DEFAULT_RUNNER_CRITERIA`):**
- `min_hit_rate_x2: 0.30` ‚Äî –º–∏–Ω–∏–º—É–º 30% —Å–¥–µ–ª–æ–∫ –¥–æ–ª–∂–Ω—ã –¥–æ—Å—Ç–∏—á—å x2
- `min_hit_rate_x5: 0.10` ‚Äî –º–∏–Ω–∏–º—É–º 10% —Å–¥–µ–ª–æ–∫ –¥–æ–ª–∂–Ω—ã –¥–æ—Å—Ç–∏—á—å x5
- `min_tail_contribution: 0.3` ‚Äî –º–∏–Ω–∏–º—É–º 30% PnL –æ—Ç top 5% —Å–¥–µ–ª–æ–∫
- `max_drawdown_pct: -0.5` ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞ –Ω–µ –±–æ–ª–µ–µ 50%

**–õ–æ–≥–∏–∫–∞ –æ—Ç–±–æ—Ä–∞:**
- Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø–æ Runner –∫—Ä–∏—Ç–µ—Ä–∏—è–º
- RR/RRD —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `strategy_selection.csv` —Å —Ñ–ª–∞–≥–æ–º `passed` –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.

---

## Baseline –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

### –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

**–£—Ä–æ–≤–Ω–∏ TP:**
```yaml
take_profit_levels:
  - { xn: 2.0, fraction: 0.4 }   # 40% –Ω–∞ 2x
  - { xn: 5.0, fraction: 0.4 }   # 40% –Ω–∞ 5x
  - { xn: 10.0, fraction: 0.2 }  # 20% –Ω–∞ 10x
```

**Time stop:**
- `20160` –º–∏–Ω—É—Ç (14 –¥–Ω–µ–π) –∏–ª–∏
- `30240` –º–∏–Ω—É—Ç (21 –¥–µ–Ω—å)

**–î—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `use_high_for_targets: true` ‚Äî –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ HIGH –∫–∞–∫ —Ç—Ä–∏–≥–≥–µ—Ä
- `exit_on_first_tp: false` ‚Äî –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –≤—Å—é –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –ø–µ—Ä–≤–æ–º TP
- `allow_partial_fills: true` ‚Äî —Ä–∞–∑—Ä–µ—à–∏—Ç—å —á–∞—Å—Ç–∏—á–Ω—ã–µ —Ñ–∏–∫—Å–∞—Ü–∏–∏

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –û—Å—Ç–∞—Ç–æ–∫ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ `close` –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–≤–µ—á–∏ –æ–∫–Ω–∞ (–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏).

---

## –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

### ‚úÖ –ë–µ–∑ –ø–æ—Ä—Ç—Ñ–µ–ª—è: runner ladder –¥–∞—ë—Ç –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–π realized_multiple

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
pytest tests/domain/test_runner_ladder.py -v
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ß–∞—Å—Ç–∏—á–Ω—ã–µ –≤—ã—Ö–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- Time stop –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫
- `realized_multiple` —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### ‚úÖ –° –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º, –±–µ–∑ reset: equity curve –Ω–µ —É–º–∏—Ä–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
python main.py --strategies-config config/strategies_example.yaml
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å portfolio_summary.csv: max_drawdown_pct –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- Equity curve –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–æ—Å—Ç —Å –ø—Ä–æ—Å–∞–¥–∫–∞–º–∏
- `tail_contribution > 0.3` (–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Ö–≤–æ—Å—Ç–∞)
- –ß–∞—Å—Ç–∏—á–Ω—ã–µ –≤—ã—Ö–æ–¥—ã —É–º–µ–Ω—å—à–∞—é—Ç —ç–∫—Å–ø–æ–∑–∏—Ü–∏—é

### ‚úÖ –° reset: –ø–æ—è–≤–ª—è—é—Ç—Å—è —Ü–∏–∫–ª—ã

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```yaml
# –í config/backtest_example.yaml
portfolio:
  runner_reset_enabled: true
  runner_reset_multiple: 2.0
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- `portfolio_summary.csv` —Å–æ–¥–µ—Ä–∂–∏—Ç `reset_count > 0`
- `last_reset_time` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- `cycle_start_equity` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ reset

### ‚úÖ Stage B: –Ω–∞—á–∏–Ω–∞–µ—Ç –æ—Ç–±–∏—Ä–∞—Ç—å Runner-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
python -m backtester.decision.run_stage_b
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å strategy_selection.csv: Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å passed=True/False
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø–æ Runner –∫—Ä–∏—Ç–µ—Ä–∏—è–º
- "–•–æ—Ä–æ—à–∏–µ" —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç (`hit_rate_x2 >= 0.30`, `hit_rate_x5 >= 0.10`)
- "–ú—É—Å–æ—Ä" –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ—Ç—Å—è

---

## –ò—Ç–æ–≥

Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º—É:

1. ‚úÖ **Core –ª–æ–≥–∏–∫–∞:** `runner_ladder.py` + `runner_strategy.py`
2. ‚úÖ **Portfolio –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** –ß–∞—Å—Ç–∏—á–Ω—ã–µ –≤—ã—Ö–æ–¥—ã + portfolio-level reset
3. ‚úÖ **Research:** XN-–∞–Ω–∞–ª–∏–∑ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
4. ‚úÖ **Stage A/B:** Runner-–º–µ—Ç—Ä–∏–∫–∏ –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ç–±–æ—Ä–∞
5. ‚úÖ **Baseline –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:** –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –≤ `DEFAULT_RUNNER_CRITERIA` –∏ `strategies_example.yaml`

–í—Å–µ –º–æ–¥—É–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞: –æ—Ç research –¥–æ –æ—Ç–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π.

---

## –°–º. —Ç–∞–∫–∂–µ

- [RUNNER_MODULES_REFERENCE.md](./RUNNER_MODULES_REFERENCE.md) ‚Äî –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π –∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
- [XN_RUNNER_RESEARCH.md](./XN_RUNNER_RESEARCH.md) ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ XN-–∞–Ω–∞–ª–∏–∑—É
- [runner_config_example.yaml](./runner_config_example.yaml) ‚Äî –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Runner



