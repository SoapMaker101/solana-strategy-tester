# –ê—É–¥–∏—Ç —Ç–µ—Å—Ç–æ–≤ –∏ –∫–æ–¥–∞ PortfolioEngine

## –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- ‚úÖ **21 —Ç–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç**
- ‚ùå **5 —Ç–µ—Å—Ç–æ–≤ –ø–∞–¥–∞—é—Ç**
- **–í—Å–µ–≥–æ: 26 —Ç–µ—Å—Ç–æ–≤**

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 1: max_exposure –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –£–ø–∞–≤—à–∏–µ —Ç–µ—Å—Ç—ã:
1. `test_max_exposure_rejects_second_trade` 
2. `test_max_exposure_with_fixed_allocation`

### –ê–Ω–∞–ª–∏–∑:
**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ –≤ `portfolio.py:274`:**
```python
max_allowed_notional = self.config.max_exposure * total_capital - total_open_notional
```

**–ü—Ä–∏–º–µ—Ä –∏–∑ —Ç–µ—Å—Ç–∞:**
- –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: 10.0 SOL
- max_exposure: 0.5 (50%)
- –ü–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞: 4.0 SOL (—ç–∫—Å–ø–æ–∑–∏—Ü–∏—è 40% - OK)
- –ü–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è: balance = 6.0, total_open_notional = 4.0
- –í—Ç–æ—Ä–∞—è —Å–¥–µ–ª–∫–∞ –∂–µ–ª–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: 2.4 SOL
- **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ (6.4 / 12.4 = 51.6% > 50%)
- **–†–µ–∞–ª—å–Ω–æ—Å—Ç—å:** –æ–±–µ —Å–¥–µ–ª–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ñ–æ—Ä–º—É–ª–µ:**
- `total_capital = available_balance + total_open_notional = 6.0 + 4.0 = 10.0` (—ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- `max_allowed_notional = 0.5 * 10.0 - 4.0 = 5.0 - 4.0 = 1.0`
- `desired_size = 2.4`, `size = min(2.4, 1.0) = 1.0`
- **–ü—Ä–æ–±–ª–µ–º–∞:** –∫–æ–¥ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é 1.0 SOL, —Ö–æ—Ç—è —ç—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞:**
–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏ —ç–∫—Å–ø–æ–∑–∏—Ü–∏—è –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç –ª–∏–º–∏—Ç:
```
(new_total_open_notional) / (available_balance + new_total_open_notional) <= max_exposure

–≥–¥–µ new_total_open_notional = total_open_notional + new_size
```

–†–µ—à–∞–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏–µ:
```
(total_open_notional + new_size) / (available_balance + total_open_notional + new_size) <= max_exposure

total_open_notional + new_size <= max_exposure * (available_balance + total_open_notional + new_size)
total_open_notional + new_size <= max_exposure * (available_balance + total_open_notional) + max_exposure * new_size
total_open_notional + new_size - max_exposure * new_size <= max_exposure * (available_balance + total_open_notional)
new_size * (1 - max_exposure) <= max_exposure * (available_balance + total_open_notional) - total_open_notional
new_size <= (max_exposure * (available_balance + total_open_notional) - total_open_notional) / (1 - max_exposure)
```

**–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞:**
```python
if max_exposure >= 1.0:
    max_allowed_notional = float('inf')  # –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
else:
    numerator = max_exposure * (available_balance + total_open_notional) - total_open_notional
    max_allowed_notional = numerator / (1 - max_exposure)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ:**
- available_balance = 6.0
- total_open_notional = 4.0
- max_exposure = 0.5
- numerator = 0.5 * 10.0 - 4.0 = 1.0
- max_allowed_notional = 1.0 / 0.5 = 2.0
- desired_size = 2.4 > 2.0 ‚Üí –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –¥–æ 2.0, –Ω–æ —Ç–æ–≥–¥–∞:
  - new_exposure = (4.0 + 2.0) / (6.0 + 4.0 + 2.0) = 6.0 / 12.0 = 0.5 = 50% ‚úÖ

**–ù–û:** —Ç–µ—Å—Ç –æ–∂–∏–¥–∞–µ—Ç **–ø–æ–ª–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ** —Å–¥–µ–ª–∫–∏, –µ—Å–ª–∏ –∂–µ–ª–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä > max_allowed_notional, –∞ –Ω–µ —á–∞—Å—Ç–∏—á–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 2: runner reset –º–µ—Ç–∫–∏ –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è

### –£–ø–∞–≤—à–∏–µ —Ç–µ—Å—Ç—ã:
1. `test_runner_reset_closes_all_positions_on_xn`
2. `test_runner_reset_with_multiple_xn_levels`

### –ê–Ω–∞–ª–∏–∑:
**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ –≤ `portfolio.py:215-221`:**
```python
if (self.config.runner_reset_enabled and 
    pos.entry_price > 0 and pos.exit_price is not None):
    multiplying_return = pos.exit_price / pos.entry_price
    if multiplying_return >= self.config.runner_reset_multiple:
        reset_triggered = True
        reset_until = pos.exit_time
        pos.meta["triggered_reset"] = True  # ‚Üê –ú–µ—Ç–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
```

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- –ú–µ—Ç–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ü–û–°–õ–ï —Ç–æ–≥–æ, –∫–∞–∫ –ø–æ–∑–∏—Ü–∏—è —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ `closed_positions` (—Å—Ç—Ä–æ–∫–∞ 206)
- –ù–æ –≤ —Ç–µ—Å—Ç–∞—Ö –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `trigger_position.meta.get("triggered_reset")`, –∏ –º–µ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

**–í–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:** 
- –ü–æ–∑–∏—Ü–∏—è –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –∏–ª–∏ –º–µ—Ç–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –ª–∏–±–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç–∞.

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –í –≤—ã–≤–æ–¥–µ —Ç–µ—Å—Ç–∞ –≤–∏–¥–Ω–æ:
```
meta={'strategy': 'test_strategy', 'raw_pnl_pct': 1.0, 'fee_pct': 0.20850000000000002, 'pnl_sol': 0.7915}
```
–ù–µ—Ç `triggered_reset` –≤ –º–µ—Ç–∞!

**–í—ã–≤–æ–¥:** –ú–µ—Ç–∫–∞ –ù–ï –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è, —Ö–æ—Ç—è –∫–æ–¥ –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ª–∏ `meta` –ø–æ–∑–∂–µ.

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 3: runner reset exit_time –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

### –£–ø–∞–≤—à–∏–π —Ç–µ—Å—Ç:
1. `test_runner_reset_with_three_trades_first_triggers_reset`

### –ê–Ω–∞–ª–∏–∑:
**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ –≤ `portfolio.py:229-249`:**
```python
if reset_triggered:
    reset_time = reset_until
    if reset_time:
        for pos in still_open:
            if pos.exit_time is None:
                continue
            close_time = min(reset_time, pos.exit_time) if pos.exit_time else reset_time
            # ... —Ä–∞—Å—á–µ—Ç PnL ...
            pos.meta["closed_by_reset"] = True
            pos.status = "closed"
            # ... –Ω–æ pos.exit_time –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è!
            equity_curve.append({"timestamp": close_time, "balance": balance})
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è `close_time = min(reset_time, pos.exit_time)`, –Ω–æ `pos.exit_time` –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ `close_time`
- –í —Ç–µ—Å—Ç–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è: `position2.exit_time <= reset_time`
- –†–µ–∞–ª—å–Ω–æ—Å—Ç—å: `exit_time = 2024-01-01 14:00:00` (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π), `reset_time = 2024-01-01 13:00:00`
- **–û–∂–∏–¥–∞–µ—Ç—Å—è:** `exit_time` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ `reset_time` –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏

**–†–µ—à–µ–Ω–∏–µ:** –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å `pos.exit_time = close_time` –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ reset.

---

## ‚úÖ –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —è–≤–ª—è—é—Ç—Å—è –ø—Ä–æ–±–ª–µ–º–∞–º–∏

### –¢–µ—Å—Ç—ã max_exposure –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã:
- –¢–µ—Å—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç –æ–∂–∏–¥–∞–µ–º—É—é —ç–∫—Å–ø–æ–∑–∏—Ü–∏—é
- –¢–µ—Å—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–∂–∏–¥–∞—é—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏
- –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –∞ –Ω–µ –≤ —Ç–µ—Å—Ç–∞—Ö

### –¢–µ—Å—Ç—ã runner reset –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã:
- –û–∂–∏–¥–∞–Ω–∏—è —Ä–∞–∑—É–º–Ω—ã: –º–µ—Ç–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å, exit_time –¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è
- –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –∞ –Ω–µ –≤ —Ç–µ—Å—Ç–∞—Ö

---

## üìã –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å max_exposure (–∫—Ä–∏—Ç–∏—á–Ω–æ)
1. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Ñ–æ—Ä–º—É–ª—É —Ä–∞—Å—á–µ—Ç–∞ `max_allowed_notional`
2. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É: –µ—Å–ª–∏ `desired_size > max_allowed_notional`, –º–æ–∂–Ω–æ –ª–∏–±–æ:
   - –û—Ç–∫–ª–æ–Ω–∏—Ç—å —Å–¥–µ–ª–∫—É –ø–æ–ª–Ω–æ—Å—Ç—å—é (–∫–∞–∫ –æ–∂–∏–¥–∞—é—Ç —Ç–µ—Å—Ç—ã)
   - –ò–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –¥–æ `max_allowed_notional` (—Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û—Ç–∫–ª–æ–Ω–∏—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é, —Ç–∞–∫ –∫–∞–∫ —Ç–µ—Å—Ç—ã –æ–∂–∏–¥–∞—é—Ç –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ.

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å runner reset –º–µ—Ç–∫–∏ (–≤–∞–∂–Ω–æ)
1. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –º–µ—Ç–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –î–û –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ `closed_positions`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ª–∏ –º–µ—Ç–∞ –ø–æ–∑–∂–µ –≤ –∫–æ–¥–µ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ò—Å–ø—Ä–∞–≤–∏—Ç—å runner reset exit_time (–≤–∞–∂–Ω–æ)
1. –û–±–Ω–æ–≤–ª—è—Ç—å `pos.exit_time = close_time` –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ `closed_positions`

---

## üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞:
- –ö–æ–¥ —á–∏—Ç–∞–µ–º—ã–π, –Ω–æ –µ—Å—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–π (—Å—Ç—Ä–æ–∫–∏ 199-212, 229-249, 317-331)
- –ú–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –º–µ—Ç–æ–¥ `_close_position(pos, close_time, balance)`

### –¢–µ—Å—Ç—ã:
- –¢–µ—Å—Ç—ã —Ö–æ—Ä–æ—à–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
- –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –º–æ–≥–ª–∏ –±—ã –±—ã—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω—ã –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
