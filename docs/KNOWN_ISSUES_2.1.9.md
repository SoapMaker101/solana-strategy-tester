# Known Issues — Version 2.1.9

**Дата фиксации:** 2025-01-06  
**Статус:** Осознанно отложены для версии 2.2+

Этот документ фиксирует известные технические проблемы, которые **не блокируют работу системы**, но требуют отдельного цикла разработки для исправления.

---

## Категории проблем

- **Typing:** Basedpyright warnings, неполные type hints
- **Technical Debt:** Эвристики, неявная логика, архитектурные упрощения
- **Pandas Types:** Неполные type hints для pandas операций
- **Documentation:** Недостающая документация для некоторых компонентов

---

## Issue #1: Basedpyright typing warnings

**Файл:** Множество файлов в `backtester/`

**Тип:** Typing / Static analysis

**Описание:**
Basedpyright выдает множество warnings о:
- Неполных type hints (`Any`, `Dict[str, Any]`)
- Отсутствующих type annotations
- Несовместимых типах в некоторых местах

**Риск:** Низкий. Код работает корректно, warnings не влияют на runtime.

**Примеры:**
- `backtester/application/runner.py`: некоторые методы используют `Any`
- `backtester/domain/models.py`: `meta: Dict[str, Any]` вместо строгих типов
- `backtester/infrastructure/reporter.py`: pandas операции без полных type hints

**Планируемый fix:** Версия 2.2 (typing cleanup)

**Почему не исправлялось в 2.1.9:**
- Не блокирует работу системы
- Требует значительного объема работы
- Лучше сделать отдельным циклом с полным покрытием

---

## Issue #2: V2-хак в select_strategies

**Файл:** `backtester/decision/strategy_selector.py`

**Тип:** Technical Debt / Architecture

**Описание:**
В функции `select_strategies` есть неявная логика определения V2 критериев:

```python
if runner_criteria is None:
    required_v2_cols = {"hit_rate_x4", "tail_pnl_share", "non_tail_pnl_share"}
    has_v2_cols = required_v2_cols.issubset(set(stability_df.columns))
    if has_v2_cols and (criteria.min_hit_rate_x2 is None and criteria.min_hit_rate_x5 is None):
        runner_criteria = criteria
        criteria = DEFAULT_CRITERIA_V1
```

**Риск:** Средний. Логика работает, но неявная и может быть непонятна новым разработчикам.

**Проблема:**
- Неявное определение V2 критериев через проверку колонок
- Эвристика вместо явного указания версии
- Усложняет понимание кода

**Планируемый fix:** Версия 2.2 (refactoring)

**Будущий рефактор:**
```python
select_strategies(
    stability_df,
    base_criteria: SelectionCriteria,
    runner_criteria: Optional[RunnerCriteria]
)
```

**Почему не исправлялось в 2.1.9:**
- Работает корректно
- Требует изменения сигнатуры функции
- Может сломать существующие вызовы
- Лучше сделать отдельным циклом с миграцией

**См. также:** `docs/TEST_GREEN_BASELINE_2025-01-06.md` (TECH_DEBT секция)

---

## Issue #3: Pandas type hints неполные

**Файл:** Множество файлов, использующих pandas

**Тип:** Typing / Type hints

**Описание:**
Многие операции с pandas DataFrame/Series не имеют полных type hints:
- `pd.DataFrame` без указания типов колонок
- `pd.Series` без указания типа значений
- Операции `df[...]` возвращают `Any`

**Риск:** Низкий. Код работает, но IDE не может предоставить полную поддержку автодополнения.

**Примеры:**
- `backtester/infrastructure/reporter.py`: `df.to_csv()` без type hints
- `backtester/audit/invariants.py`: операции с DataFrame без строгих типов
- `backtester/research/strategy_stability.py`: агрегации без type hints

**Планируемый fix:** Версия 2.2 (pandas type hints)

**Почему не исправлялось в 2.1.9:**
- Pandas typing сложен и требует дополнительных зависимостей
- Не критично для работы системы
- Лучше сделать отдельным циклом

---

## Issue #4: Эвристики для определения версий

**Файл:** `backtester/decision/strategy_selector.py`

**Тип:** Technical Debt / Code quality

**Описание:**
В некоторых местах используется `hasattr` для определения версии критериев или наличия полей:

```python
is_v2 = runner_criteria is not None and hasattr(runner_criteria, "min_hit_rate_x4")
```

**Риск:** Низкий. Работает, но не идеально с точки зрения type safety.

**Проблема:**
- Неявная логика определения версий
- Зависимость от структуры объектов через `hasattr`
- Усложняет рефакторинг

**Планируемый fix:** Версия 2.2 (refactoring)

**Почему не исправлялось в 2.1.9:**
- Работает корректно
- Требует изменения архитектуры
- Лучше сделать отдельным циклом

---

## Issue #5: Недостающая документация для некоторых компонентов

**Файл:** Различные модули

**Тип:** Documentation

**Описание:**
Некоторые компоненты имеют недостаточную документацию:
- Не все функции имеют docstrings
- Некоторые сложные алгоритмы не документированы
- Примеры использования отсутствуют для некоторых API

**Риск:** Низкий. Код работает, но может быть сложнее понять новым разработчикам.

**Примеры:**
- `backtester/domain/runner_ladder.py`: алгоритм ladder simulation
- `backtester/research/window_aggregator.py`: window-based агрегация
- `backtester/domain/execution_model.py`: slippage calculation

**Планируемый fix:** Постепенно, в рамках обычной разработки

**Почему не исправлялось в 2.1.9:**
- Не критично для работы системы
- Можно улучшать постепенно
- Не требует отдельного цикла

---

## Issue #6: Архитектурные упрощения

**Файл:** Различные модули

**Тип:** Architecture / Technical Debt

**Описание:**
Некоторые слои можно упростить или реорганизовать:
- Разделение ответственности между некоторыми модулями
- Дублирование логики в некоторых местах
- Возможность вынести общие утилиты

**Риск:** Низкий. Система работает, но может быть сложнее поддерживать.

**Примеры:**
- Нормализация reason разбросана по нескольким файлам
- Некоторые утилиты можно вынести в общие модули
- Некоторые классы можно упростить

**Планируемый fix:** Версия 3.0 (если потребуется)

**Почему не исправлялось в 2.1.9:**
- Не критично для работы системы
- Требует значительного рефакторинга
- Риск внесения регрессий
- Лучше сделать отдельным циклом с полным тестированием

---

## Резюме

Все перечисленные проблемы **не блокируют работу системы** и осознанно отложены для будущих версий:

- **Версия 2.2:** Typing cleanup, basedpyright fixes, pandas type hints, refactoring V2-хака
- **Версия 2.3:** Analytics improvements, новые метрики
- **Версия 3.0:** Архитектурные изменения (если потребуются)

**Философия:** Версия 2.1.9 — это стабильный baseline. Проблемы зафиксированы, но не исправляются, чтобы не рисковать стабильностью системы.

---

**См. также:**
- `docs/RELEASE_2.1.9.md` — полное описание релиза
- `docs/TEST_GREEN_BASELINE_2025-01-06.md` — контракты и guard-тесты

