# Объяснение различий в расчете PnL

## Проблема

Strategy-level отчеты показывают **Total PnL: 30.00%**, а Portfolio-level показывает **Total return: 2.85%**. Почему такая разница?

## Причина различий

### Strategy-level отчеты (HTML/CSV)

**Метод расчета:**
```python
total_pnl = sum(pnls)  # Просто сумма процентов
# Для RR_15_10: 15% + 15% = 30%
```

**Что это означает:**
- Это **арифметическая сумма процентов** от каждой сделки
- **НЕ учитывает:**
  - Размер позиций
  - Динамический баланс
  - Комиссии и проскальзывание
  - Взаимодействие между сделками

**Пример:**
- Сделка 1: PnL = 15%
- Сделка 2: PnL = 15%
- Total PnL = 30% ❌ (это НЕ реальная доходность портфеля!)

### Portfolio-level отчеты

**Метод расчета:**
```python
total_return_pct = (final_balance - initial_balance) / initial_balance
# Для RR_15_10: (10.285 - 10.0) / 10.0 = 2.85%
```

**Что это означает:**
- Это **реальная доходность портфеля**
- **Учитывает:**
  - Размер позиций (10% от баланса каждая)
  - Динамический баланс (после первой сделки баланс меняется)
  - Комиссии и проскальзывание
  - Правильную последовательность открытия/закрытия позиций

## Детальный расчет для RR_15_10

### Исходные данные:
- Начальный баланс: **10.0 SOL**
- Allocation mode: **dynamic** (10% от текущего баланса)
- Сделка 1 (test1): PnL = 15%
- Сделка 2 (test2): PnL = 15%

### Portfolio-level расчет:

**Сделка 1 (test1):**
- Entry time: 2025-12-05 00:00:00
- Размер позиции: 10% от 10.0 SOL = **1.0 SOL**
- Баланс после открытия: 10.0 - 1.0 = **9.0 SOL**
- PnL: 15% от 1.0 SOL = **0.15 SOL**
- Exit time: 2025-12-09 16:30:00
- Баланс после закрытия: 9.0 + 1.0 + 0.15 = **10.15 SOL**

**Сделка 2 (test2):**
- Entry time: 2025-12-09 00:00:00 (открывается ДО закрытия первой!)
- Размер позиции: 10% от 9.0 SOL = **0.9 SOL** (от доступного баланса)
- Баланс после открытия: 9.0 - 0.9 = **8.1 SOL**
- Exit time: 2025-12-09 01:30:00 (закрывается ПЕРЕД первой)
- PnL: 15% от 0.9 SOL = **0.135 SOL**
- Баланс после закрытия: 8.1 + 0.9 + 0.135 = **9.135 SOL**

**Закрытие первой позиции:**
- Exit time: 2025-12-09 16:30:00
- Баланс после закрытия: 9.135 + 1.0 + 0.15 = **10.285 SOL**

**Итоговая доходность:**
- Final balance: **10.285 SOL**
- Total return: (10.285 - 10.0) / 10.0 = **2.85%** ✅

### Strategy-level расчет:

**Просто сумма процентов:**
- Total PnL = 15% + 15% = **30%** ❌

**Почему это неправильно:**
- Предполагает, что обе сделки открыты одновременно с одинаковым размером
- Не учитывает, что вторая сделка открывается от меньшего баланса
- Не учитывает последовательность открытия/закрытия

## Почему Portfolio-level правильный

1. **Учитывает размер позиций:**
   - Первая сделка: 1.0 SOL (10% от 10.0)
   - Вторая сделка: 0.9 SOL (10% от 9.0, потому что баланс уже уменьшен)

2. **Учитывает динамический баланс:**
   - После открытия первой позиции баланс = 9.0 SOL
   - Вторая позиция рассчитывается от 9.0 SOL, а не от 10.0 SOL

3. **Учитывает последовательность:**
   - Вторая сделка открывается ДО закрытия первой
   - При закрытии второй сделки баланс = 9.135 SOL
   - При закрытии первой сделки баланс = 10.285 SOL

4. **Реальная доходность:**
   - 2.85% - это реальная доходность портфеля
   - 30% - это просто сумма процентов, не имеющая смысла для портфеля

## Выводы

1. **Strategy-level отчеты** показывают PnL каждой сделки отдельно (без учета портфеля)
2. **Portfolio-level отчеты** показывают реальную доходность портфеля с учетом:
   - Размеров позиций
   - Динамического баланса
   - Последовательности сделок
   - Комиссий и проскальзывания

3. **Для оценки реальной прибыльности стратегии** нужно смотреть на **Portfolio-level отчеты**

4. **Strategy-level отчеты** полезны для:
   - Анализа качества сигналов
   - Понимания поведения стратегии на отдельных сделках
   - Но НЕ для оценки реальной доходности портфеля

## Рекомендации

1. **Основной метрикой** должна быть **Portfolio-level Total return**
2. **Strategy-level Total PnL** можно использовать только для сравнения стратегий на уровне отдельных сделок
3. При использовании **dynamic allocation** разница будет особенно заметна, так как размер позиций зависит от текущего баланса

## Примеры

### Fixed allocation (10% от начального баланса):
- Все сделки: 1.0 SOL каждая
- Strategy-level: 15% + 15% = 30%
- Portfolio-level: (10.0 + 0.15 + 0.15) / 10.0 = 3.0% (ближе к 30%, но все равно не то же самое)

### Dynamic allocation (10% от текущего баланса):
- Первая сделка: 1.0 SOL (10% от 10.0)
- Вторая сделка: 0.9 SOL (10% от 9.0)
- Strategy-level: 15% + 15% = 30%
- Portfolio-level: 2.85% (значительно меньше из-за уменьшения размера второй позиции)
