# Portfolio Events v1.9 - Статус реализации

**Дата начала:** 2025-01-XX  
**Дата релиза:** 2025-01-XX  
**Статус:** ✅ **DONE** - Релиз v1.9 завершен

---

## Цель v1.9

Ввести каноническую семантику Portfolio Events как "источник истины" для всех решений портфеля. Устранить двусмысленность "trade == attempt", четко разделить ATTEMPT (попытка входа) и EXECUTED (реальная позиция).

---

## Выполнено

### ✅ Коммит #1: Базовая структура событий

**Файлы:**
- `backtester/domain/portfolio_events.py` - создан (новый файл)
- `backtester/domain/portfolio.py` - обновлен

**Что сделано:**
1. Создан `PortfolioEvent` dataclass с полями:
   - `timestamp`, `strategy`, `signal_id`, `contract_address`
   - `event_type: PortfolioEventType`
   - `reason`, `result: StrategyOutput`, `meta`

2. Создан `PortfolioEventType` Enum с типами:
   - `ATTEMPT_RECEIVED`, `ATTEMPT_ACCEPTED_OPEN`, `ATTEMPT_REJECTED_CAPACITY`, `ATTEMPT_REJECTED_RISK`
   - `ATTEMPT_REJECTED_STRATEGY_NO_ENTRY`, `ATTEMPT_REJECTED_NO_CANDLES`, `ATTEMPT_REJECTED_CORRUPT_CANDLES`
   - `ATTEMPT_REJECTED_INVALID_INPUT`
   - `EXECUTED_CLOSE`, `CLOSED_BY_CAPACITY_PRUNE`, `CLOSED_BY_PROFIT_RESET`, `CLOSED_BY_CAPACITY_CLOSE_ALL`
   - `CAPACITY_PRUNE_TRIGGERED`, `CAPACITY_CLOSE_ALL_TRIGGERED`, `PROFIT_RESET_TRIGGERED`

3. Добавлено поле `portfolio_events: List[PortfolioEvent]` в `PortfolioStats`

4. Добавлены helper-методы `PortfolioEvent.create_*()` для создания событий

**Импорты:**
```python
from .portfolio_events import PortfolioEvent, PortfolioEventType
```

---

### ✅ Коммит #2: Эмиссия событий для attempts

**Файлы:**
- `backtester/domain/portfolio.py` - обновлен метод `simulate()` и `_try_open_position()`

**Что сделано:**
1. В `simulate()` создается список `portfolio_events: List[PortfolioEvent] = []`
2. В обработке ENTRY событий:
   - Эмитится `ATTEMPT_RECEIVED` при получении сигнала
   - Эмитится `ATTEMPT_REJECTED_STRATEGY_NO_ENTRY` при runner reset cooldown
3. В `_try_open_position()`:
   - Эмитится `ATTEMPT_REJECTED_CAPACITY` при отклонении по capacity (max_open_positions, meta флаг)
   - Эмитится `ATTEMPT_REJECTED_RISK` при отклонении по риск-правилам (max_exposure, size <= 0)
   - Эмитится `ATTEMPT_REJECTED_INVALID_INPUT` при некорректных ценах
   - Эмитится `ATTEMPT_ACCEPTED_OPEN` при успешном открытии позиции

4. Список событий передается в `PortfolioStats` при создании

**Параметры методов:**
- `_try_open_position(..., portfolio_events: Optional[List[PortfolioEvent]] = None)`
- `_process_position_exit(..., portfolio_events: Optional[List[PortfolioEvent]] = None)`
- `_forced_close_position(..., portfolio_events: Optional[List[PortfolioEvent]] = None)`
- `_maybe_apply_capacity_prune(..., portfolio_events: Optional[List[PortfolioEvent]] = None)`

---

### ✅ Коммит #3: События закрытий + Capacity window на событиях

**Файлы:**
- `backtester/domain/portfolio.py` - обновлены методы закрытия и capacity logic

**Что сделано:**

1. **События закрытий:**
   - В `_forced_close_position()`: эмитится событие по типу `reset_reason`:
     - `"capacity_prune"` → `CLOSED_BY_CAPACITY_PRUNE`
     - `"profit"` → `CLOSED_BY_PROFIT_RESET`
     - `"capacity"` / `"capacity_close_all"` → `CLOSED_BY_CAPACITY_CLOSE_ALL`
     - Иначе → `EXECUTED_CLOSE`
   - В `_process_position_exit()`: эмитится `EXECUTED_CLOSE` при обычном закрытии

2. **Capacity window на событиях (главный фикс):**
   - Создана функция `_build_capacity_window_from_events()`:
     - Для `window_type="signals"`: берет последние N событий типа `ATTEMPT_ACCEPTED_OPEN` или `ATTEMPT_REJECTED_CAPACITY`
     - Для `window_type="time"`: берет события за последние N дней
   - В `_maybe_apply_capacity_prune()`:
     - Заменена логика расчета `blocked_ratio`:
       - Старая: `blocked_window / signals_in_window` (из capacity_tracking)
       - Новая: `rejected_capacity_count / attempted` (из событий)
       - `attempted = accepted_open_count + rejected_capacity_count`
     - Эмитится `CAPACITY_PRUNE_TRIGGERED` при срабатывании prune

3. **BacktestRunner.signals_processed:**
   - Исправлена логика: инкрементируется только если стратегия была вызвана (есть свечи)
   - Инкремент происходит один раз на сигнал (не на каждую стратегию)

**Критическая формула (v1.9 канон):**
```python
window_events = _build_capacity_window_from_events(...)  # Последние N attempt событий
accepted_open_count = count(ATTEMPT_ACCEPTED_OPEN in window_events)
rejected_capacity_count = count(ATTEMPT_REJECTED_CAPACITY in window_events)
attempted = accepted_open_count + rejected_capacity_count
blocked_ratio = rejected_capacity_count / attempted  # Если attempted > 0
```

---

### ✅ Коммит #4: События reset + BC пересчет счетчиков

**Файлы:**
- `backtester/domain/portfolio.py` - обновлен метод `_apply_reset()` и пересчет счетчиков
- `backtester/domain/portfolio_events.py` - добавлены helper-методы для reset событий

**Что сделано:**

1. **Эмиссия событий для reset операций:**
   - В `_apply_reset()` добавлена эмиссия событий:
     - `PROFIT_RESET_TRIGGERED` для `ResetReason.EQUITY_THRESHOLD`
     - `CAPACITY_CLOSE_ALL_TRIGGERED` для `ResetReason.CAPACITY_PRESSURE`
     - `CLOSED_BY_PROFIT_RESET` для каждой закрытой позиции при profit reset
     - `CLOSED_BY_CAPACITY_CLOSE_ALL` для каждой закрытой позиции при capacity close-all
   - Все вызовы `_apply_reset()` обновлены для передачи `portfolio_events`

2. **Helper-методы в PortfolioEvent:**
   - `create_profit_reset_triggered()`
   - `create_capacity_close_all_triggered()`

3. **Пересчет BC счетчиков из событий:**
   - В конце `simulate()` перед созданием `PortfolioStats`:
     - `portfolio_capacity_prune_count` из `CLOSED_BY_CAPACITY_PRUNE`
     - `portfolio_reset_capacity_count` из `CAPACITY_CLOSE_ALL_TRIGGERED`
     - `portfolio_reset_profit_count` из `PROFIT_RESET_TRIGGERED`
     - `portfolio_reset_count = portfolio_reset_profit_count + portfolio_reset_capacity_count`
     - `last_capacity_prune_time`, `last_portfolio_reset_time` из событий

4. **BacktestRunner.signals_processed:**
   - Логика уже исправлена (инкремент только если стратегия вызвана)
   - Тесты уже синхронизированы (проверка показала корректность)

---

### ✅ Коммит #5: Экспорт portfolio_events.csv

**Файлы:**
- `backtester/infrastructure/reporter.py` - добавлен метод `save_portfolio_events_table()`
- `main.py` - добавлен вызов экспорта событий

**Что сделано:**
1. **Метод `save_portfolio_events_table()`:**
   - Экспортирует события в CSV с колонками: `timestamp`, `event_type`, `strategy`, `signal_id`, `contract_address`, `position_id`, `meta_json`
   - `meta_json` сериализуется через `json.dumps(meta, ensure_ascii=False)`
   - Fail-safe: продолжает работу при ошибке записи CSV

2. **Автоматический экспорт:**
   - Вызывается вместе с `save_portfolio_positions_table()` и `save_portfolio_executions_table()`
   - Файл: `output/reports/portfolio_events.csv`

3. **Тест:**
   - `tests/infrastructure/test_reporter_exports_events_csv.py` - проверяет экспорт и валидность CSV

### ✅ Коммит #6: Исправления capacity prune и runner counters

**Файлы:**
- `backtester/domain/portfolio.py` - исправлен capacity prune (v1.9 events, robust к None)
- `backtester/application/runner.py` - исправлены счетчики skip
- `tests/portfolio/test_portfolio_capacity_prune.py` - обновлены тесты

**Что сделано:**
1. **Capacity prune к v1.9:**
   - `avg_hold_days` считается напрямую из открытых позиций (не из capacity_tracking)
   - Фильтры кандидатов robust к None (mcap_usd, current_pnl_pct)
   - Trigger эмитится только если есть позиции для закрытия

2. **Runner counters:**
   - `signals_skipped_no_candles` инкрементируется при пустых свечах
   - `signals_processed` инкрементируется только при вызове стратегии

3. **Тесты:**
   - Ослаблены фильтры prune-кандидатов для детерминированности
   - Добавлен `prune_min_candidates=1` в тесты

### ✅ Коммит #7: Cleanup и helpers

**Файлы:**
- `tests/helpers/events.py` - создан helper для работы с событиями
- `tests/portfolio/test_portfolio_capacity_prune.py` - используется helper вместо локальной функции
- `tests/portfolio/test_debug_portfolio_reset_marker.py` - удалены временные print

**Что сделано:**
1. **Helper для событий:**
   - `count_event(stats, event_type)` - подсчет событий
   - `events(stats, event_type)` - получение списка событий
   - `counter(stats)` - словарь счетчиков по типам

2. **Cleanup:**
   - Удалены временные debug print из тестов
   - Вынесена общая логика в helpers

### ✅ Коммит #8: Документация v1.9

**Файлы:**
- `README.md` - добавлен раздел про Portfolio Events v1.9
- `docs/CHANGELOG.md` - добавлена запись о v1.9
- `docs/V1.9_IMPLEMENTATION_STATUS.md` - обновлен статус

**Что сделано:**
1. **README.md:**
   - Добавлена таблица типов событий (ATTEMPT vs EXECUTED)
   - Добавлена формула capacity window (signals-based)
   - Описаны принципы v1.9 (events = source of truth, BC recompute, etc.)

2. **CHANGELOG.md:**
   - Добавлена полная запись о v1.9 с техническими деталями
   - Описаны все изменения и инварианты

---

## ✅ Выполнено полностью (P0, P1, P2) - РЕЛИЗ v1.9

Все задачи выполнены, релиз v1.9 завершен.

---

## Ключевые файлы

**Измененные:**
- `backtester/domain/portfolio_events.py` - новый файл
- `backtester/domain/portfolio.py` - эмиссия событий, capacity window
- `backtester/application/runner.py` - signals_processed логика

**Нужно изменить:**
- `backtester/domain/portfolio_reset.py` - добавить события для reset (или в portfolio.py в _apply_reset)
- `backtester/infrastructure/reporter.py` - экспорт portfolio_events.csv
- Тесты - обновить под новую семантику
- Документация - обновить

---

## Важные замечания

1. **События append-only:** События не удаляются, только добавляются в `portfolio_events`

2. **Источник истины:** `portfolio_events` - канонический источник для:
   - Capacity pressure / window
   - Prune/reset триггеры
   - BC счетчики

3. **Backward compatibility:** Старые счетчики (`portfolio_capacity_prune_count` и т.д.) пересчитываются из событий, но остаются в `PortfolioStats` для BC

4. **ATTEMPT vs EXECUTED:**
   - ATTEMPT - попытка входа (стратегия хотела войти)
   - EXECUTED - реальная позиция (открыта портфелем)
   - Stage A/B используют только EXECUTED позиции

5. **Capacity window формула (канон v1.9):**
   ```
   window = последние N событий типа ATTEMPT_ACCEPTED_OPEN + ATTEMPT_REJECTED_CAPACITY
   attempted = accepted_open + rejected_capacity
   blocked_ratio = rejected_capacity / attempted
   ```

---

## Команды для проверки

```bash
# Проверка capacity prune тестов
pytest tests/portfolio/test_portfolio_capacity_prune.py -q -v

# Проверка runner тестов
pytest tests/application/test_runner_empty_candles.py -q -v

# Полный прогон
pytest tests/ -q

# Проверка линтера
pylint backtester/domain/portfolio_events.py
pylint backtester/domain/portfolio.py
```

---

## ✅ Все задачи выполнены

1. ✅ **Критично:** Добавить эмиссию событий в `apply_portfolio_reset()` (profit reset, capacity close-all) - ВЫПОЛНЕНО (коммит #4)
2. ✅ **Важно:** Добавить пересчет BC счетчиков из событий - ВЫПОЛНЕНО (коммит #4)
3. ✅ **Важно:** Протестировать на реальных тестах - ВЫПОЛНЕНО (коммит #6, все тесты зелёные)
4. ✅ **Средне:** Экспорт portfolio_events.csv (опционально) - ВЫПОЛНЕНО (коммит #5)
5. ✅ **Средне:** Обновление тестов (миграция на events) - ВЫПОЛНЕНО (коммит #6)
6. ✅ **Низко:** Документация (README, CHANGELOG) - ВЫПОЛНЕНО (коммит #8)

---

**Последнее обновление:** 2025-01-XX  
**Статус:** ✅ **РЕЛИЗ v1.9 ЗАВЕРШЕН**

**Выполнено:**
- ✅ P0.1: Reset эмитит события (profit reset + capacity close-all)
- ✅ P0.2: Тесты runner_empty_candles синхронизированы
- ✅ P0.3: Event mapping для no_candles/corrupt/strategy_no_entry
- ✅ P1.1: BC пересчет счетчиков из событий
- ✅ P1.2: Экспорт portfolio_events.csv
- ✅ P2.1: Миграция тестов на events
- ✅ P2.2: Документация (README, CHANGELOG, статус)

**Релизные фиксы:**
- ✅ PortfolioEvents append-only (канонический источник истины)
- ✅ Capacity pressure из ATTEMPT_ACCEPTED_OPEN + ATTEMPT_REJECTED_CAPACITY
- ✅ include_skipped_attempts=True в main.py
- ✅ meta.detail канонизирован (no_candles, corrupt_candles)
- ✅ Детерминированный маппинг в PortfolioEngine
- ✅ Исправления prune-candidates (None-friendly фильтры)
- ✅ Strategy filter убран из signals-window


