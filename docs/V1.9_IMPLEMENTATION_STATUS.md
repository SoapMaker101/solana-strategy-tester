# Portfolio Events v1.9 - –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:** –°–µ–≥–æ–¥–Ω—è  
**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:** P0 –∏ P1.1 –≤—ã–ø–æ–ª–Ω–µ–Ω—ã (–∫–æ–º–º–∏—Ç—ã #1-#4)  
**–û—Å—Ç–∞–ª–æ—Å—å:** P1.2 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ), P2 (—Ç–µ—Å—Ç—ã + –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)

---

## –¶–µ–ª—å v1.9

–í–≤–µ—Å—Ç–∏ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫—É—é —Å–µ–º–∞–Ω—Ç–∏–∫—É Portfolio Events –∫–∞–∫ "–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã" –¥–ª—è –≤—Å–µ—Ö —Ä–µ—à–µ–Ω–∏–π –ø–æ—Ä—Ç—Ñ–µ–ª—è. –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç—å "trade == attempt", —á–µ—Ç–∫–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å ATTEMPT (–ø–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞) –∏ EXECUTED (—Ä–µ–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è).

---

## –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### ‚úÖ –ö–æ–º–º–∏—Ç #1: –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–±—ã—Ç–∏–π

**–§–∞–π–ª—ã:**
- `backtester/domain/portfolio_events.py` - —Å–æ–∑–¥–∞–Ω (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
- `backtester/domain/portfolio.py` - –æ–±–Ω–æ–≤–ª–µ–Ω

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
1. –°–æ–∑–¥–∞–Ω `PortfolioEvent` dataclass —Å –ø–æ–ª—è–º–∏:
   - `timestamp`, `strategy`, `signal_id`, `contract_address`
   - `event_type: PortfolioEventType`
   - `reason`, `result: StrategyOutput`, `meta`

2. –°–æ–∑–¥–∞–Ω `PortfolioEventType` Enum —Å —Ç–∏–ø–∞–º–∏:
   - `ATTEMPT_RECEIVED`, `ATTEMPT_ACCEPTED_OPEN`, `ATTEMPT_REJECTED_CAPACITY`, `ATTEMPT_REJECTED_RISK`
   - `ATTEMPT_REJECTED_STRATEGY_NO_ENTRY`, `ATTEMPT_REJECTED_NO_CANDLES`, `ATTEMPT_REJECTED_CORRUPT_CANDLES`
   - `ATTEMPT_REJECTED_INVALID_INPUT`
   - `EXECUTED_CLOSE`, `CLOSED_BY_CAPACITY_PRUNE`, `CLOSED_BY_PROFIT_RESET`, `CLOSED_BY_CAPACITY_CLOSE_ALL`
   - `CAPACITY_PRUNE_TRIGGERED`, `CAPACITY_CLOSE_ALL_TRIGGERED`, `PROFIT_RESET_TRIGGERED`

3. –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `portfolio_events: List[PortfolioEvent]` –≤ `PortfolioStats`

4. –î–æ–±–∞–≤–ª–µ–Ω—ã helper-–º–µ—Ç–æ–¥—ã `PortfolioEvent.create_*()` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π

**–ò–º–ø–æ—Ä—Ç—ã:**
```python
from .portfolio_events import PortfolioEvent, PortfolioEventType
```

---

### ‚úÖ –ö–æ–º–º–∏—Ç #2: –≠–º–∏—Å—Å–∏—è —Å–æ–±—ã—Ç–∏–π –¥–ª—è attempts

**–§–∞–π–ª—ã:**
- `backtester/domain/portfolio.py` - –æ–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `simulate()` –∏ `_try_open_position()`

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
1. –í `simulate()` —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ `portfolio_events: List[PortfolioEvent] = []`
2. –í –æ–±—Ä–∞–±–æ—Ç–∫–µ ENTRY —Å–æ–±—ã—Ç–∏–π:
   - –≠–º–∏—Ç–∏—Ç—Å—è `ATTEMPT_RECEIVED` –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–∞
   - –≠–º–∏—Ç–∏—Ç—Å—è `ATTEMPT_REJECTED_STRATEGY_NO_ENTRY` –ø—Ä–∏ runner reset cooldown
3. –í `_try_open_position()`:
   - –≠–º–∏—Ç–∏—Ç—Å—è `ATTEMPT_REJECTED_CAPACITY` –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –ø–æ capacity (max_open_positions, meta —Ñ–ª–∞–≥)
   - –≠–º–∏—Ç–∏—Ç—Å—è `ATTEMPT_REJECTED_RISK` –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –ø–æ —Ä–∏—Å–∫-–ø—Ä–∞–≤–∏–ª–∞–º (max_exposure, size <= 0)
   - –≠–º–∏—Ç–∏—Ç—Å—è `ATTEMPT_REJECTED_INVALID_INPUT` –ø—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Ü–µ–Ω–∞—Ö
   - –≠–º–∏—Ç–∏—Ç—Å—è `ATTEMPT_ACCEPTED_OPEN` –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏

4. –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `PortfolioStats` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–µ—Ç–æ–¥–æ–≤:**
- `_try_open_position(..., portfolio_events: Optional[List[PortfolioEvent]] = None)`
- `_process_position_exit(..., portfolio_events: Optional[List[PortfolioEvent]] = None)`
- `_forced_close_position(..., portfolio_events: Optional[List[PortfolioEvent]] = None)`
- `_maybe_apply_capacity_prune(..., portfolio_events: Optional[List[PortfolioEvent]] = None)`

---

### ‚úÖ –ö–æ–º–º–∏—Ç #3: –°–æ–±—ã—Ç–∏—è –∑–∞–∫—Ä—ã—Ç–∏–π + Capacity window –Ω–∞ —Å–æ–±—ã—Ç–∏—è—Ö

**–§–∞–π–ª—ã:**
- `backtester/domain/portfolio.py` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã –∑–∞–∫—Ä—ã—Ç–∏—è –∏ capacity logic

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**

1. **–°–æ–±—ã—Ç–∏—è –∑–∞–∫—Ä—ã—Ç–∏–π:**
   - –í `_forced_close_position()`: —ç–º–∏—Ç–∏—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ –ø–æ —Ç–∏–ø—É `reset_reason`:
     - `"capacity_prune"` ‚Üí `CLOSED_BY_CAPACITY_PRUNE`
     - `"profit"` ‚Üí `CLOSED_BY_PROFIT_RESET`
     - `"capacity"` / `"capacity_close_all"` ‚Üí `CLOSED_BY_CAPACITY_CLOSE_ALL`
     - –ò–Ω–∞—á–µ ‚Üí `EXECUTED_CLOSE`
   - –í `_process_position_exit()`: —ç–º–∏—Ç–∏—Ç—Å—è `EXECUTED_CLOSE` –ø—Ä–∏ –æ–±—ã—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏

2. **Capacity window –Ω–∞ —Å–æ–±—ã—Ç–∏—è—Ö (–≥–ª–∞–≤–Ω—ã–π —Ñ–∏–∫—Å):**
   - –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_build_capacity_window_from_events()`:
     - –î–ª—è `window_type="signals"`: –±–µ—Ä–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–±—ã—Ç–∏–π —Ç–∏–ø–∞ `ATTEMPT_ACCEPTED_OPEN` –∏–ª–∏ `ATTEMPT_REJECTED_CAPACITY`
     - –î–ª—è `window_type="time"`: –±–µ—Ä–µ—Ç —Å–æ–±—ã—Ç–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π
   - –í `_maybe_apply_capacity_prune()`:
     - –ó–∞–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ `blocked_ratio`:
       - –°—Ç–∞—Ä–∞—è: `blocked_window / signals_in_window` (–∏–∑ capacity_tracking)
       - –ù–æ–≤–∞—è: `rejected_capacity_count / attempted` (–∏–∑ —Å–æ–±—ã—Ç–∏–π)
       - `attempted = accepted_open_count + rejected_capacity_count`
     - –≠–º–∏—Ç–∏—Ç—Å—è `CAPACITY_PRUNE_TRIGGERED` –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ prune

3. **BacktestRunner.signals_processed:**
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞: –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –±—ã–ª–∞ –≤—ã–∑–≤–∞–Ω–∞ (–µ—Å—Ç—å —Å–≤–µ—á–∏)
   - –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ —Å–∏–≥–Ω–∞–ª (–Ω–µ –Ω–∞ –∫–∞–∂–¥—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é)

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º—É–ª–∞ (v1.9 –∫–∞–Ω–æ–Ω):**
```python
window_events = _build_capacity_window_from_events(...)  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ N attempt —Å–æ–±—ã—Ç–∏–π
accepted_open_count = count(ATTEMPT_ACCEPTED_OPEN in window_events)
rejected_capacity_count = count(ATTEMPT_REJECTED_CAPACITY in window_events)
attempted = accepted_open_count + rejected_capacity_count
blocked_ratio = rejected_capacity_count / attempted  # –ï—Å–ª–∏ attempted > 0
```

---

### ‚úÖ –ö–æ–º–º–∏—Ç #4: –°–æ–±—ã—Ç–∏—è reset + BC –ø–µ—Ä–µ—Å—á–µ—Ç —Å—á–µ—Ç—á–∏–∫–æ–≤

**–§–∞–π–ª—ã:**
- `backtester/domain/portfolio.py` - –æ–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_apply_reset()` –∏ –ø–µ—Ä–µ—Å—á–µ—Ç —Å—á–µ—Ç—á–∏–∫–æ–≤
- `backtester/domain/portfolio_events.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã helper-–º–µ—Ç–æ–¥—ã –¥–ª—è reset —Å–æ–±—ã—Ç–∏–π

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**

1. **–≠–º–∏—Å—Å–∏—è —Å–æ–±—ã—Ç–∏–π –¥–ª—è reset –æ–ø–µ—Ä–∞—Ü–∏–π:**
   - –í `_apply_reset()` –¥–æ–±–∞–≤–ª–µ–Ω–∞ —ç–º–∏—Å—Å–∏—è —Å–æ–±—ã—Ç–∏–π:
     - `PROFIT_RESET_TRIGGERED` –¥–ª—è `ResetReason.EQUITY_THRESHOLD`
     - `CAPACITY_CLOSE_ALL_TRIGGERED` –¥–ª—è `ResetReason.CAPACITY_PRESSURE`
     - `CLOSED_BY_PROFIT_RESET` –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–∫—Ä—ã—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ profit reset
     - `CLOSED_BY_CAPACITY_CLOSE_ALL` –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–∫—Ä—ã—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ capacity close-all
   - –í—Å–µ –≤—ã–∑–æ–≤—ã `_apply_reset()` –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ `portfolio_events`

2. **Helper-–º–µ—Ç–æ–¥—ã –≤ PortfolioEvent:**
   - `create_profit_reset_triggered()`
   - `create_capacity_close_all_triggered()`

3. **–ü–µ—Ä–µ—Å—á–µ—Ç BC —Å—á–µ—Ç—á–∏–∫–æ–≤ –∏–∑ —Å–æ–±—ã—Ç–∏–π:**
   - –í –∫–æ–Ω—Ü–µ `simulate()` –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º `PortfolioStats`:
     - `portfolio_capacity_prune_count` –∏–∑ `CLOSED_BY_CAPACITY_PRUNE`
     - `portfolio_reset_capacity_count` –∏–∑ `CAPACITY_CLOSE_ALL_TRIGGERED`
     - `portfolio_reset_profit_count` –∏–∑ `PROFIT_RESET_TRIGGERED`
     - `portfolio_reset_count = portfolio_reset_profit_count + portfolio_reset_capacity_count`
     - `last_capacity_prune_time`, `last_portfolio_reset_time` –∏–∑ —Å–æ–±—ã—Ç–∏–π

4. **BacktestRunner.signals_processed:**
   - –õ–æ–≥–∏–∫–∞ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –≤—ã–∑–≤–∞–Ω–∞)
   - –¢–µ—Å—Ç—ã —É–∂–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑–∞–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å)

---

## –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å

### üî≤ P1.2 (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –≠–∫—Å–ø–æ—Ä—Ç portfolio_events.csv

**–°—Ç–∞—Ç—É—Å:** –ß–∞—Å—Ç–∏—á–Ω–æ —Å–¥–µ–ª–∞–Ω–æ (–ª–æ–≥–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞, –Ω–æ —Ç–µ—Å—Ç—ã –µ—â–µ –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã)

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ `signals_processed` –≤ `BacktestRunner` (–ì–û–¢–û–í–û)
2. ‚ö†Ô∏è –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –≤ `tests/application/test_runner_empty_candles.py`:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç–µ—Å—Ç—ã –æ–∂–∏–¥–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å–µ–º–∞–Ω—Ç–∏–∫—É
   - –ï—Å–ª–∏ –Ω—É–∂–Ω–æ - –¥–æ–±–∞–≤–∏—Ç—å —ç–º–∏—Å—Å–∏—é —Å–æ–±—ã—Ç–∏–π `ATTEMPT_REJECTED_NO_CANDLES` / `ATTEMPT_REJECTED_CORRUPT_CANDLES` –≤ BacktestRunner

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `BacktestRunner._process_signal()` –Ω–µ—Ç —ç–º–∏—Å—Å–∏–∏ —Å–æ–±—ã—Ç–∏–π –ø–æ—Ä—Ç—Ñ–µ–ª—è (—ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è). Runner —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è. –ù—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å:
- –õ–∏–±–æ —ç–º–∏—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ Runner (–Ω–æ –æ–Ω–∏ –Ω–µ –ø–æ–ø–∞–¥—É—Ç –≤ PortfolioStats.portfolio_events)
- –õ–∏–±–æ —Å—á–∏—Ç–∞—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ Runner –æ—Ç–¥–µ–ª—å–Ω–æ (—á—Ç–æ –∏ –¥–µ–ª–∞–µ—Ç—Å—è —Å–µ–π—á–∞—Å)

**–†–µ—à–µ–Ω–∏–µ:** –û—Å—Ç–∞–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ Runner –∫–∞–∫ –µ—Å—Ç—å (–æ–Ω–∏ BC). –°–æ–±—ã—Ç–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è —ç–º–∏—Ç—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ PortfolioEngine.

---

2. **portfolio_events.csv —ç–∫—Å–ø–æ—Ä—Ç:**
   - –í `Reporter` –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `export_portfolio_events()` –∏–ª–∏ –≤ `save_portfolio_report()`
   - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `export_events: bool = False`
   - –§–æ—Ä–º–∞—Ç CSV:
     ```
     timestamp,strategy,signal_id,contract_address,event_type,reason,has_result,entry_time,entry_price,meta_json
     ```
   - –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è `meta` –≤ JSON —Å—Ç—Ä–æ–∫—É

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `backtester/domain/portfolio.py` - –ø–µ—Ä–µ—Å—á–µ—Ç BC —Å—á–µ—Ç—á–∏–∫–æ–≤
- `backtester/infrastructure/reporter.py` (–∏–ª–∏ –≥–¥–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –æ—Ç—á–µ—Ç) - —ç–∫—Å–ø–æ—Ä—Ç CSV

---

### üî≤ –ö–æ–º–º–∏—Ç #6: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**

1. **tests/application/test_runner_empty_candles.py:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º `signals_processed`
   - –ï—Å–ª–∏ –Ω–µ—Ç - –æ–±–Ω–æ–≤–∏—Ç—å –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–æ–≤–æ–π —Å–µ–º–∞–Ω—Ç–∏–∫–µ

2. **tests/portfolio/test_portfolio_capacity_prune.py:**
   - ‚úÖ Blocked attempts —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `meta={"blocked_by_capacity": True}` (–ì–û–¢–û–í–û)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π —Å–æ–±—ã—Ç–∏–π
   - –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `portfolio_events` –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤

3. **–ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
   - –¢–µ—Å—Ç –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç `portfolio_events.csv`
   - –¢–µ—Å—Ç –Ω–∞ –ø–µ—Ä–µ—Å—á–µ—Ç BC —Å—á–µ—Ç—á–∏–∫–æ–≤ –∏–∑ —Å–æ–±—ã—Ç–∏–π

---

### üî≤ P2.2: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**

1. **README.md:**
   - –†–∞–∑–¥–µ–ª "Semantics v1.9: Attempts vs Executed"
   - –û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –ø–æ—Ä—Ç—Ñ–µ–ª—è

2. **docs/portfolio.md:**
   - –û–±–Ω–æ–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ capacity pressure (—Ç–µ–ø–µ—Ä—å –Ω–∞ —Å–æ–±—ã—Ç–∏—è—Ö)
   - –û–ø–∏—Å–∞—Ç—å prune/reset —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è
   - Priority rules

3. **docs/research.md:**
   - Stage A/B consume —Ç–æ–ª—å–∫–æ executed trades (–Ω–µ attempts)

4. **docs/testing.md:**
   - –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Ç–µ—Å—Ç–æ–≤ –¥–ª—è capacity pressure –≤ v1.9
   - –ö–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å blocked attempts –ø—Ä–∞–≤–∏–ª—å–Ω–æ

5. **CHANGELOG.md:**
   - v1.9 breaking changes
   - Migration notes v1.8 ‚Üí v1.9

---

## –¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã / TODO

### 1. apply_portfolio_reset –Ω–µ —ç–º–∏—Ç–∏—Ç —Å–æ–±—ã—Ç–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** `apply_portfolio_reset()` –≤ `backtester/domain/portfolio_reset.py` –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏, –Ω–æ –Ω–µ —ç–º–∏—Ç–∏—Ç —Å–æ–±—ã—Ç–∏—è.

**–†–µ—à–µ–Ω–∏–µ:**
- –í–∞—Ä–∏–∞–Ω—Ç A: –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å `portfolio_events` —á–µ—Ä–µ–∑ `PortfolioResetContext`
- –í–∞—Ä–∏–∞–Ω—Ç B: –≠–º–∏—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ `_apply_reset()` –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ `apply_portfolio_reset()`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í–∞—Ä–∏–∞–Ω—Ç B –ø—Ä–æ—â–µ - –≤ `_apply_reset()` –ø–æ—Å–ª–µ `apply_portfolio_reset()` —ç–º–∏—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π.

**–ú–µ—Å—Ç–∞ –≤—ã–∑–æ–≤–∞ `_apply_reset()`:**
- Runner XN reset (—Å—Ç—Ä–æ–∫–∞ ~1323)
- Profit reset (—Å—Ç—Ä–æ–∫–∞ ~1919)
- Capacity reset close-all (—Å—Ç—Ä–æ–∫–∞ ~1960)
- Final profit reset (—Å—Ç—Ä–æ–∫–∞ ~2034)

### ‚úÖ 2. Capacity window: avg_hold_days –≤—Å–µ –µ—â–µ –∏–∑ capacity_tracking (–û–ö)

**–ü—Ä–æ–±–ª–µ–º–∞:** `avg_hold_days` —Å—á–∏—Ç–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `capacity_tracking`, –∞ –Ω–µ –∏–∑ —Å–æ–±—ã—Ç–∏–π.

**–†–µ—à–µ–Ω–∏–µ:** –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - `avg_hold_days` —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –æ—Ç–∫—Ä—ã—Ç—ã–º –ø–æ–∑–∏—Ü–∏—è–º, –Ω–µ –ø–æ —Å–æ–±—ã—Ç–∏—è–º. –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å.

### ‚ö†Ô∏è 3. –¢–µ—Å—Ç—ã capacity prune –º–æ–≥—É—Ç –µ—â–µ –ø–∞–¥–∞—Ç—å (–ù–£–ñ–ù–û –ü–†–û–í–ï–†–ò–¢–¨)

**–ü—Ä–∏—á–∏–Ω–∞:** –í–æ–∑–º–æ–∂–Ω–æ, —Å–æ–±—ã—Ç–∏—è –µ—â–µ –Ω–µ –≤—Å–µ —ç–º–∏—Ç—è—Ç—Å—è, –∏–ª–∏ –æ–∫–Ω–æ —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- Blocked attempts –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞—é—Ç `ATTEMPT_REJECTED_CAPACITY` —Å–æ–±—ã—Ç–∏—è
- –û–∫–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ç—Ä–æ–∏—Ç—Å—è –∏–∑ —Å–æ–±—ã—Ç–∏–π
- `blocked_ratio` –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è

---

## –ö–∞–∫ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É

### ‚úÖ –®–∞–≥ 1: –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –∑–∞–∫—Ä—ã—Ç–∏–π (–í–´–ü–û–õ–ù–ï–ù–û)

–í—Å–µ –ø—É—Ç–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π –ø–æ–∫—Ä—ã—Ç—ã —Å–æ–±—ã—Ç–∏—è–º–∏:
- –û–±—ã—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ ‚Üí `EXECUTED_CLOSE` ‚úÖ
- Capacity prune ‚Üí `CLOSED_BY_CAPACITY_PRUNE` ‚úÖ
- Profit reset ‚Üí `CLOSED_BY_PROFIT_RESET` ‚úÖ
- Capacity close-all ‚Üí `CLOSED_BY_CAPACITY_CLOSE_ALL` ‚úÖ

### ‚úÖ –®–∞–≥ 2: BC —Å—á–µ—Ç—á–∏–∫–∏ (–í–´–ü–û–õ–ù–ï–ù–û)

–ü–µ—Ä–µ—Å—á–µ—Ç —Å—á–µ—Ç—á–∏–∫–æ–≤ –∏–∑ —Å–æ–±—ã—Ç–∏–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ –∫–æ–Ω—Ü–µ `simulate()`

### –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å `pytest tests/portfolio/test_portfolio_capacity_prune.py -q -v`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ - –µ—Å—Ç—å –ª–∏ —Å–æ–±—ã—Ç–∏—è `ATTEMPT_REJECTED_CAPACITY` –≤ `portfolio_events`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è `blocked_ratio` –∏–∑ —Å–æ–±—ã—Ç–∏–π
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å - –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ª–∏ BC —Å—á–µ—Ç—á–∏–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –®–∞–≥ 4 (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –≠–∫—Å–ø–æ—Ä—Ç CSV

1. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ `Reporter` –∏–ª–∏ –≤ –º–µ—Å—Ç–æ, –≥–¥–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `portfolio_positions.csv`
2. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞

### –®–∞–≥ 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

1. –ü—Ä–æ–≥–Ω–∞—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã: `pytest tests/ -q`
2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–∞–¥–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–æ–≤–æ–π —Å–µ–º–∞–Ω—Ç–∏–∫–µ
3. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –Ω–∞ —Å–æ–±—ã—Ç–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –®–∞–≥ 6: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

1. –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ docs —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–∏—Å–∫—É –≤—ã—à–µ
2. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π

---

## –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

**–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ:**
- `backtester/domain/portfolio_events.py` - –Ω–æ–≤—ã–π —Ñ–∞–π–ª
- `backtester/domain/portfolio.py` - —ç–º–∏—Å—Å–∏—è —Å–æ–±—ã—Ç–∏–π, capacity window
- `backtester/application/runner.py` - signals_processed –ª–æ–≥–∏–∫–∞

**–ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å:**
- `backtester/domain/portfolio_reset.py` - –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –¥–ª—è reset (–∏–ª–∏ –≤ portfolio.py –≤ _apply_reset)
- `backtester/infrastructure/reporter.py` - —ç–∫—Å–ø–æ—Ä—Ç portfolio_events.csv
- –¢–µ—Å—Ç—ã - –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥ –Ω–æ–≤—É—é —Å–µ–º–∞–Ω—Ç–∏–∫—É
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è - –æ–±–Ω–æ–≤–∏—Ç—å

---

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–°–æ–±—ã—Ç–∏—è append-only:** –°–æ–±—ã—Ç–∏—è –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è, —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ `portfolio_events`

2. **–ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã:** `portfolio_events` - –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è:
   - Capacity pressure / window
   - Prune/reset —Ç—Ä–∏–≥–≥–µ—Ä—ã
   - BC —Å—á–µ—Ç—á–∏–∫–∏

3. **Backward compatibility:** –°—Ç–∞—Ä—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ (`portfolio_capacity_prune_count` –∏ —Ç.–¥.) –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∏–∑ —Å–æ–±—ã—Ç–∏–π, –Ω–æ –æ—Å—Ç–∞—é—Ç—Å—è –≤ `PortfolioStats` –¥–ª—è BC

4. **ATTEMPT vs EXECUTED:**
   - ATTEMPT - –ø–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ (—Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ö–æ—Ç–µ–ª–∞ –≤–æ–π—Ç–∏)
   - EXECUTED - —Ä–µ–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è (–æ—Ç–∫—Ä—ã—Ç–∞ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º)
   - Stage A/B –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–æ–ª—å–∫–æ EXECUTED –ø–æ–∑–∏—Ü–∏–∏

5. **Capacity window —Ñ–æ—Ä–º—É–ª–∞ (–∫–∞–Ω–æ–Ω v1.9):**
   ```
   window = –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–±—ã—Ç–∏–π —Ç–∏–ø–∞ ATTEMPT_ACCEPTED_OPEN + ATTEMPT_REJECTED_CAPACITY
   attempted = accepted_open + rejected_capacity
   blocked_ratio = rejected_capacity / attempted
   ```

---

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ capacity prune —Ç–µ—Å—Ç–æ–≤
pytest tests/portfolio/test_portfolio_capacity_prune.py -q -v

# –ü—Ä–æ–≤–µ—Ä–∫–∞ runner —Ç–µ—Å—Ç–æ–≤
pytest tests/application/test_runner_empty_candles.py -q -v

# –ü–æ–ª–Ω—ã–π –ø—Ä–æ–≥–æ–Ω
pytest tests/ -q

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞
pylint backtester/domain/portfolio_events.py
pylint backtester/domain/portfolio.py
```

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

1. ‚úÖ **–ö—Ä–∏—Ç–∏—á–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å —ç–º–∏—Å—Å–∏—é —Å–æ–±—ã—Ç–∏–π –≤ `apply_portfolio_reset()` (profit reset, capacity close-all) - –í–´–ü–û–õ–ù–ï–ù–û
2. ‚úÖ **–í–∞–∂–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ—Å—á–µ—Ç BC —Å—á–µ—Ç—á–∏–∫–æ–≤ –∏–∑ —Å–æ–±—ã—Ç–∏–π - –í–´–ü–û–õ–ù–ï–ù–û
3. **–í–∞–∂–Ω–æ:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–∞—Ö (`pytest tests/portfolio/ -q`)
4. **–°—Ä–µ–¥–Ω–µ:** –≠–∫—Å–ø–æ—Ä—Ç portfolio_events.csv (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
5. **–°—Ä–µ–¥–Ω–µ:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ (–º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ events)
6. **–ù–∏–∑–∫–æ:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (README, CHANGELOG)

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –°–µ–≥–æ–¥–Ω—è  
**–°—Ç–∞—Ç—É—Å:** P0 –∏ P1.1 –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∏ P2

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:**
- ‚úÖ P0.1: Reset —ç–º–∏—Ç–∏—Ç —Å–æ–±—ã—Ç–∏—è (profit reset + capacity close-all)
- ‚úÖ P0.2: –¢–µ—Å—Ç—ã runner_empty_candles —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ P1.1: BC –ø–µ—Ä–µ—Å—á–µ—Ç —Å—á–µ—Ç—á–∏–∫–æ–≤ –∏–∑ —Å–æ–±—ã—Ç–∏–π

**–û—Å—Ç–∞–ª–æ—Å—å:**
- üî≤ P1.2: –≠–∫—Å–ø–æ—Ä—Ç portfolio_events.csv (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- üî≤ P2.1: –ú–∏–≥—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤ –Ω–∞ events
- üî≤ P2.2: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è


