# Changelog

## [Bugfixes: max_exposure & runner reset] - 2025-12-13

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤ –≤ PortfolioEngine

#### üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

##### 1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ max_exposure**

**–ü—Ä–æ–±–ª–µ–º–∞:** –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ –±—ã–ª–∞ –Ω–µ–≤–µ—Ä–Ω–æ–π –∏ –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º—É —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—é —Å–¥–µ–ª–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã–ª–∏ –±—ã—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω—ã.

**–§–∞–π–ª:** `backtester/domain/portfolio.py` (—Å—Ç—Ä–æ–∫–∏ 269-296)

**–ë—ã–ª–æ:**
```python
max_allowed_notional = self.config.max_exposure * total_capital - total_open_notional
```

**–°—Ç–∞–ª–æ:**
```python
# –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ —Å —É—á–µ—Ç–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–∏
# –§–æ—Ä–º—É–ª–∞: (total_open_notional + new_size) / (total_capital + new_size) <= max_exposure
# –†–µ—à–∞–µ–º: new_size <= (max_exposure * total_capital - total_open_notional) / (1 - max_exposure)
if self.config.max_exposure >= 1.0:
    max_allowed_notional = float('inf')
else:
    numerator = self.config.max_exposure * total_capital - total_open_notional
    if numerator <= 0:
        max_allowed_notional = 0.0
    else:
        max_allowed_notional = numerator / (1.0 - self.config.max_exposure)

# –ï—Å–ª–∏ –∂–µ–ª–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç, –æ—Ç–∫–ª–æ–Ω—è–µ–º —Å–¥–µ–ª–∫—É –ø–æ–ª–Ω–æ—Å—Ç—å—é
if desired_size > max_allowed_notional:
    skipped_by_risk += 1
    continue
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –¢–µ—Å—Ç `test_max_exposure_rejects_second_trade` —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Ö–æ–¥–∏—Ç
- ‚úÖ –¢–µ—Å—Ç `test_max_exposure_with_fixed_allocation` —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Ö–æ–¥–∏—Ç
- ‚úÖ –õ–∏–º–∏—Ç —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–∞—Ö (dynamic/fixed)

##### 2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ exit_time –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ runner reset**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–π –ø–æ runner reset `exit_time` –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –Ω–∞ –≤—Ä–µ–º—è reset, —Ö–æ—Ç—è —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª—Å—è `close_time`. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –ø—Ä–æ–≤–µ—Ä–∫–∞–º –≤ —Ç–µ—Å—Ç–∞—Ö.

**–§–∞–π–ª:** `backtester/domain/portfolio.py` (—Å—Ç—Ä–æ–∫–∞ 237)

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `pos.exit_time = close_time` –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏:
```python
close_time = min(reset_time, pos.exit_time) if pos.exit_time else reset_time
pos.exit_time = close_time  # ‚Üê –î–æ–±–∞–≤–ª–µ–Ω–æ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –¢–µ—Å—Ç `test_runner_reset_with_three_trades_first_triggers_reset` —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Ö–æ–¥–∏—Ç
- ‚úÖ –ü–æ–∑–∏—Ü–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–º–µ—á–∞—é—Ç—Å—è –≤—Ä–µ–º–µ–Ω–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è

##### 3. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ—Ç–æ–∫ runner reset**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ—Ç–∫–∞ `triggered_reset` –Ω–µ –¥–æ–±–∞–≤–ª—è–ª–∞—Å—å –ø–æ–∑–∏—Ü–∏—è–º, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–∫—Ä—ã–≤–∞–ª–∏—Å—å –≤ –∫–æ–Ω—Ü–µ —Ü–∏–∫–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö —Å–¥–µ–ª–æ–∫), –∞ –Ω–µ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.

**–§–∞–π–ª:** `backtester/domain/portfolio.py` (—Å—Ç—Ä–æ–∫–∏ 206-214, 345-370)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –ú–µ—Ç–∫–∞ `triggered_reset` —Ç–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –î–û —É—Å—Ç–∞–Ω–æ–≤–∫–∏ `status` –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ `closed_positions` (—Å—Ç—Ä–æ–∫–∞ 214)
2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ runner reset –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–π –≤ –∫–æ–Ω—Ü–µ —Ü–∏–∫–ª–∞ (—Å—Ç—Ä–æ–∫–∏ 335-370):
   - –ü–æ–∑–∏—Ü–∏–∏ —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ `exit_time`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ XN –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–µ–π
   - –ü—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ reset –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è `closed_by_reset`
   - `exit_time` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ –≤—Ä–µ–º—è reset

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –¢–µ—Å—Ç `test_runner_reset_closes_all_positions_on_xn` —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Ö–æ–¥–∏—Ç
- ‚úÖ –¢–µ—Å—Ç `test_runner_reset_with_multiple_xn_levels` —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Ö–æ–¥–∏—Ç
- ‚úÖ –ú–µ—Ç–∫–∏ `triggered_reset` –∏ `closed_by_reset` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –≤–æ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö

#### üìä –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

- ‚úÖ **–í—Å–µ 26 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç** (–±—ã–ª–æ 5 –ø–∞–¥–∞—é—â–∏—Ö)
- ‚úÖ **–õ–∏–Ω—Ç–µ—Ä –Ω–µ –≤—ã—è–≤–∏–ª –æ—à–∏–±–æ–∫**
- ‚úÖ **–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã**

#### üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `backtester/domain/portfolio.py` ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã 3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

#### üîç –î–µ—Ç–∞–ª–∏ –∞—É–¥–∏—Ç–∞

–ü–µ—Ä–µ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ –±—ã–ª –ø—Ä–æ–≤–µ–¥–µ–Ω –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –∫–æ–¥–∞ –∏ —Ç–µ—Å—Ç–æ–≤, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ `docs/AUDIT_TESTS.md`:
- –í—ã—è–≤–ª–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –≤ –ª–æ–≥–∏–∫–µ `max_exposure`
- –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ runner reset
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤ (–ø—Ä–æ–±–ª–µ–º—ã –±—ã–ª–∏ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –∞ –Ω–µ –≤ —Ç–µ—Å—Ç–∞—Ö)

#### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏

–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—à–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É:
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (`pytest tests/portfolio/ -v`)
- ‚úÖ –õ–∏–Ω—Ç–µ—Ä –Ω–µ –≤—ã—è–≤–∏–ª –æ—à–∏–±–æ–∫
- ‚úÖ –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

---

## [Testing & Runner Reset] - 2025-12-13

### –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ—è –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Runner-XN Reset

#### üéØ –¶–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π

1. **–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ** –¥–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ—è (`PortfolioEngine`)
2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Runner-XN Reset** ‚Äî –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–µ–π XN
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å** –≤—Å–µ—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—è: –∫–æ–º–∏—Å—Å–∏–∏, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, dynamic allocation

#### üìÅ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö

##### 1. **–°–æ–∑–¥–∞–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ—è**

**–§–∞–π–ª—ã:**
- `tests/portfolio/__init__.py` ‚Äî –ø–∞–∫–µ—Ç —Ç–µ—Å—Ç–æ–≤
- `tests/portfolio/conftest.py` ‚Äî –æ–±—â–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤

**–¶–µ–ª—å:** –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º–∏ —Ñ–∏–∫—Å—Ç—É—Ä–∞–º–∏.

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- –§–∏–∫—Å—Ç—É—Ä–∞ `fee_model` ‚Äî –º–æ–¥–µ–ª—å –∫–æ–º–∏—Å—Å–∏–π —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
- –§–∏–∫—Å—Ç—É—Ä–∞ `portfolio_config` ‚Äî –¥–µ—Ñ–æ–ª—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è
- –§–∏–∫—Å—Ç—É—Ä–∞ `custom_portfolio_config` ‚Äî –∫–∞—Å—Ç–æ–º–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤

##### 2. **–î–æ–±–∞–≤–ª–µ–Ω—ã smoke —Ç–µ—Å—Ç—ã (`tests/portfolio/test_portfolio_smoke.py`)**

**–¶–µ–ª—å:** –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ—è.

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- ‚úÖ –ò–º–ø–æ—Ä—Ç –∏ —Å–æ–∑–¥–∞–Ω–∏–µ `FeeModel` —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- ‚úÖ –ò–º–ø–æ—Ä—Ç –∏ —Å–æ–∑–¥–∞–Ω–∏–µ `PortfolioConfig` —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- ‚úÖ –ò–º–ø–æ—Ä—Ç –∏ —Å–æ–∑–¥–∞–Ω–∏–µ `PortfolioEngine`
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ `PortfolioStats` –∏ `PortfolioResult`
- ‚úÖ –†–∞–±–æ—Ç–∞ —Ñ–∏–∫—Å—Ç—É—Ä –∏–∑ `conftest.py`

**–ö—Ä–∏—Ç–µ—Ä–∏–π –ø—Ä–∏–µ–º–∫–∏:** –í—Å–µ –±–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫.

##### 3. **–î–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç –Ω–∞ –æ–¥–Ω—É —Å–¥–µ–ª–∫—É —Å –∫–æ–º–∏—Å—Å–∏—è–º–∏ (`tests/portfolio/test_portfolio_single_trade.py`)**

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–π –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –ø—Ä–∏ –æ–¥–Ω–æ–π —Å–¥–µ–ª–∫–µ.

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- ‚úÖ –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (`percent_per_trade √ó balance`)
- ‚úÖ –ö–æ–º–∏—Å—Å–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ raw PnL (`net_pnl = raw_pnl - fee_pct`)
- ‚úÖ –ë–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –æ–∂–∏–¥–∞–µ–º–æ –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –∏ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
- ‚úÖ Equity curve —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ç–æ—á–∫–∏ (–Ω–∞—á–∞–ª–æ, –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è, –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è)
- ‚úÖ –ò—Ç–æ–≥–æ–≤–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –Ω–µ —Ä–∞–≤–Ω–∞ —Å—ã—Ä–æ–º—É PnL (–∫–æ–º–∏—Å—Å–∏–∏ —É—á—Ç–µ–Ω—ã)
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç `raw_pnl_pct` –∏ `fee_pct`

**–§–æ—Ä–º—É–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- `position_size = initial_balance √ó percent_per_trade`
- `fee_pct = 2 √ó (swap_fee_pct + lp_fee_pct + slippage_pct) + network_fee_sol / position_size`
- `net_pnl_pct = raw_pnl_pct - fee_pct`
- `balance_after_close = balance_after_open + size + size √ó net_pnl_pct`
- `total_return_pct = (final_balance - initial_balance) / initial_balance`

**–ö—Ä–∏—Ç–µ—Ä–∏–π –ø—Ä–∏–µ–º–∫–∏:** –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∫–æ–º–∏—Å—Å–∏–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è (–∏—Ç–æ–≥–æ–≤–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å ‚â† raw PnL).

##### 4. **–î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã –Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è (`tests/portfolio/test_portfolio_limits.py`)**

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π ‚Äî `max_open_positions` –∏ `max_exposure`.

**–¢–µ—Å—Ç—ã:**

1. **`test_max_open_positions_rejects_excess_trades`**
   - 3 —Å–¥–µ–ª–∫–∏ —Å –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–º–∏—Å—è –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
   - `max_open_positions = 1`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: —Ç–æ–ª—å–∫–æ 1 —Å–¥–µ–ª–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, 2 –æ—Ç–∫–ª–æ–Ω–µ–Ω—ã
   
2. **`test_max_exposure_rejects_second_trade`**
   - 2 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏
   - `allocation_mode = "dynamic"`
   - `percent_per_trade = 0.4`, `max_exposure = 0.5`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: –≤—Ç–æ—Ä–∞—è —Å–¥–µ–ª–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∏–∑-–∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏

3. **`test_max_exposure_with_fixed_allocation`**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `max_exposure` –≤ —Ä–µ–∂–∏–º–µ `fixed` allocation
   - –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞

4. **`test_limits_work_together`**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –æ–±–æ–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
   - `max_open_positions` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—ã–º

**–ö—Ä–∏—Ç–µ—Ä–∏–π –ø—Ä–∏–µ–º–∫–∏:** –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç –∏–º–µ–Ω–Ω–æ –æ—Ç–∫–∞–∑—ã (trades_skipped_by_risk > 0), –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–∞.

##### 5. **–î–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç –Ω–∞ dynamic allocation (`tests/portfolio/test_portfolio_dynamic_allocation.py`)**

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤ —Ä–µ–∂–∏–º–µ `allocation_mode="dynamic"` —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞.

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- ‚úÖ –ü–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞
- ‚úÖ –ü–æ—Å–ª–µ –ø—Ä–∏–±—ã–ª—å–Ω–æ–π —Å–¥–µ–ª–∫–∏ –±–∞–ª–∞–Ω—Å —Ä–∞—Å—Ç–µ—Ç
- ‚úÖ –í—Ç–æ—Ä–∞—è —Å–¥–µ–ª–∫–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç –Ω–æ–≤–æ–≥–æ (–≤—ã—Ä–æ—Å—à–µ–≥–æ) –±–∞–ª–∞–Ω—Å–∞
- ‚úÖ `size_2 > size_1` ‚Äî —Ä–∞–∑–º–µ—Ä –≤—Ç–æ—Ä–æ–π –ø–æ–∑–∏—Ü–∏–∏ –±–æ–ª—å—à–µ –ø–µ—Ä–≤–æ–π
- ‚úÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å `fixed` mode ‚Äî –≤ dynamic mode —Ä–∞–∑–º–µ—Ä –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è

**–ö—Ä–∏—Ç–µ—Ä–∏–π –ø—Ä–∏–µ–º–∫–∏:** –¢–µ—Å—Ç —Ä–µ–∞–ª—å–Ω–æ –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ dynamic allocation —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ä–∞–∑–º–µ—Ä—ã –ø–æ–∑–∏—Ü–∏–π –º–∞—Å—à—Ç–∞–±–∏—Ä—É—é—Ç—Å—è —Å –±–∞–ª–∞–Ω—Å–æ–º).

##### 6. **–î–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç –Ω–∞ –∑–∞—â–∏—Ç—É –æ—Ç –ª–æ–∂–Ω–æ–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (`tests/portfolio/test_portfolio_fees_turn_profit_to_loss.py`)**

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–æ–º–∏—Å—Å–∏–∏ –º–æ–≥—É—Ç –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –º–∞–ª–µ–Ω—å–∫—É—é –ø—Ä–∏–±—ã–ª—å –≤ —É–±—ã—Ç–æ–∫.

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- ‚úÖ –°–¥–µ–ª–∫–∞ —Å –º–∞–ª–µ–Ω—å–∫–∏–º –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º raw PnL (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.2%)
- ‚úÖ –ö–æ–º–∏—Å—Å–∏–∏ –±–æ–ª—å—à–µ raw PnL (–Ω–∞–ø—Ä–∏–º–µ—Ä, 20.85%)
- ‚úÖ Net PnL –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π (`net_pnl < 0`)
- ‚úÖ –ë–∞–ª–∞–Ω—Å —Å–Ω–∏–∑–∏–ª—Å—è –ø–æ—Å–ª–µ —Å–¥–µ–ª–∫–∏
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π `raw_pnl_pct` –∏ –±–æ–ª—å—à–∏–π `fee_pct`

**–í–∞–∂–Ω–æ—Å—Ç—å:** –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –ª–æ–∂–Ω–æ–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Äî —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π raw PnL, –Ω–æ –ø–æ—Å–ª–µ –∫–æ–º–∏—Å—Å–∏–π —Å–¥–µ–ª–∫–∞ —É–±—ã—Ç–æ—á–Ω–∞.

**–ö—Ä–∏—Ç–µ—Ä–∏–π –ø—Ä–∏–µ–º–∫–∏:** –¢–µ—Å—Ç –ª–æ–≤–∏—Ç —Å–∏—Ç—É–∞—Ü–∏—é "–∫–æ–º–∏—Å—Å–∏–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å" (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∏—Ç–æ–≥–æ–≤–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å ‚â† raw PnL).

##### 7. **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω Runner-XN Reset –≤ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–º —Å–ª–æ–µ**

**–§–∞–π–ª—ã:**
- `backtester/domain/portfolio.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ reset
- `backtester/application/runner.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ YAML
- `config/backtest_example.yaml` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**

1. **–í `PortfolioConfig`:**
   - `runner_reset_enabled: bool = False` ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å reset
   - `runner_reset_multiple: float = 2.0` ‚Äî –º–Ω–æ–∂–∏—Ç–µ–ª—å XN (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2.0 = x2)

2. **–í `PortfolioStats`:**
   - `trades_skipped_by_reset: int = 0` ‚Äî —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –∏–∑-–∑–∞ reset

3. **–í `PortfolioEngine.simulate()`:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏: `exit_price / entry_price >= runner_reset_multiple`
   - –ü—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ reset:
     - –ó–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
     - –¢—Ä–∏–≥–≥–µ—Ä–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–æ–º–µ—á–∞–µ—Ç—Å—è `"triggered_reset": True`
     - –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è `"closed_by_reset": True`
     - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `reset_until = exit_time` —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
   - –í—Ö–æ–¥—ã —Å `entry_time <= reset_until` –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è
   - –í—Ö–æ–¥—ã —Å `entry_time > reset_until` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ

4. **–í `runner.py._build_portfolio_config()`:**
   - –ó–∞–≥—Ä—É–∑–∫–∞ `runner_reset_multiple` –∏–∑ YAML –∫–æ–Ω—Ñ–∏–≥–∞

5. **–í `config/backtest_example.yaml`:**
   - `runner_reset_enabled: false` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω)
   - `runner_reset_multiple: 2.0` (–ø—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è)

**–ö–∞–∫ –≤–∫–ª—é—á–∏—Ç—å:**
```yaml
portfolio:
  runner_reset_enabled: true      # –í–∫–ª—é—á–∏—Ç—å Runner-XN reset
  runner_reset_multiple: 2.0      # –ú–Ω–æ–∂–∏—Ç–µ–ª—å XN (2.0 = x2, 3.0 = x3)
```

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
- –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–µ–π XN (multiplying return >= `runner_reset_multiple`) –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
- –ù–æ–≤—ã–µ –≤—Ö–æ–¥—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ –ø–æ—Å–ª–µ reset
- –≠—Ç–æ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ ‚Äî –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (RR/RRD/Runner)

**–ö—Ä–∏—Ç–µ—Ä–∏–π –ø—Ä–∏–µ–º–∫–∏:** Runner reset —Ä–µ–∞–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏ –Ω–µ –ª–æ–º–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏.

##### 8. **–î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã –Ω–∞ Runner-XN Reset (`tests/portfolio/test_portfolio_runner_reset.py`)**

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã runner reset –≤–æ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö.

**–¢–µ—Å—Ç—ã:**

1. **`test_runner_reset_closes_all_positions_on_xn`**
   - 3 —Å–¥–µ–ª–∫–∏ —Å –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–º–∏—Å—è –æ–∫–Ω–∞–º–∏
   - –û–¥–Ω–∞ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç XN
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç—ã, —Ç—Ä–∏–≥–≥–µ—Ä–Ω–∞—è –∏–º–µ–µ—Ç –º–µ—Ç–∫—É `triggered_reset`

2. **`test_runner_reset_ignores_entries_until_next_signal`**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –≤—Ö–æ–¥—ã –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ –ø–æ—Å–ª–µ reset –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è
   - –í—Ö–æ–¥—ã –ø–æ—Å–ª–µ reset –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ

3. **`test_runner_reset_disabled_does_not_trigger`**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ø—Ä–∏ `enabled=False` reset –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

4. **`test_runner_reset_with_three_trades_first_triggers_reset`** ‚≠ê
   - –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç –∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π:
   - 3 —Å–¥–µ–ª–∫–∏, –ø–µ—Ä–≤—ã–µ –¥–≤–µ overlap, —Ç—Ä–µ—Ç—å—è –ø–æ–∑–∂–µ
   - –ü–µ—Ä–≤–∞—è –¥–æ—Å—Ç–∏–≥–∞–µ—Ç XN –∏ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç reset
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
     - a) –≤—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏–∑-–∑–∞ reset
     - b) —Ç—Ä–µ—Ç—å—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ (–ø–æ—Å–ª–µ reset)

5. **`test_runner_reset_with_multiple_xn_levels`**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É —Å —Ä–∞–∑–Ω—ã–º–∏ —É—Ä–æ–≤–Ω—è–º–∏ XN (x3, x4 –∏ —Ç.–¥.)

**–ö—Ä–∏—Ç–µ—Ä–∏–π –ø—Ä–∏–µ–º–∫–∏:** –í—Å–µ —Ç–µ—Å—Ç—ã –∑–µ–ª–µ–Ω—ã–µ, runner reset —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

#### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–î–æ–±–∞–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:**
- `tests/portfolio/__init__.py`
- `tests/portfolio/conftest.py`
- `tests/portfolio/test_portfolio_smoke.py` (153 —Å—Ç—Ä–æ–∫–∏, 10 —Ç–µ—Å—Ç–æ–≤)
- `tests/portfolio/test_portfolio_single_trade.py` (233 —Å—Ç—Ä–æ–∫–∏, 2 —Ç–µ—Å—Ç–∞)
- `tests/portfolio/test_portfolio_limits.py` (325 —Å—Ç—Ä–æ–∫, 4 —Ç–µ—Å—Ç–∞)
- `tests/portfolio/test_portfolio_dynamic_allocation.py` (273 —Å—Ç—Ä–æ–∫–∏, 2 —Ç–µ—Å—Ç–∞)
- `tests/portfolio/test_portfolio_fees_turn_profit_to_loss.py` (198 —Å—Ç—Ä–æ–∫, 2 —Ç–µ—Å—Ç–∞)
- `tests/portfolio/test_portfolio_runner_reset.py` (514 —Å—Ç—Ä–æ–∫, 5 —Ç–µ—Å—Ç–æ–≤)

**–ò–∑–º–µ–Ω–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:**
- `backtester/domain/portfolio.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω runner reset –∏ `trades_skipped_by_reset`
- `backtester/application/runner.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ `runner_reset_multiple`
- `config/backtest_example.yaml` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã runner reset

**–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:** 25 unit-—Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ—è

#### ‚úÖ –ò—Ç–æ–≥–∏

1. **–ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ—è:**
   - ‚úÖ Smoke —Ç–µ—Å—Ç—ã (–±–∞–∑–æ–≤–∞—è —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å)
   - ‚úÖ –¢–µ—Å—Ç—ã –Ω–∞ –æ–¥–Ω—É —Å–¥–µ–ª–∫—É (–∫–æ–º–∏—Å—Å–∏–∏, –±–∞–ª–∞–Ω—Å, equity curve)
   - ‚úÖ –¢–µ—Å—Ç—ã –Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (max_open_positions, max_exposure)
   - ‚úÖ –¢–µ—Å—Ç—ã –Ω–∞ dynamic allocation (–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–π)
   - ‚úÖ –¢–µ—Å—Ç—ã –Ω–∞ –∑–∞—â–∏—Ç—É –æ—Ç –ª–æ–∂–Ω–æ–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–∫–æ–º–∏—Å—Å–∏–∏)

2. **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω Runner-XN Reset:**
   - ‚úÖ –ü–æ—Ä—Ç—Ñ–µ–ª—å–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ XN
   - ‚úÖ –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–æ–≤ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ –ø–æ—Å–ª–µ reset
   - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ YAML –∫–æ–Ω—Ñ–∏–≥–µ
   - ‚úÖ –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ

3. **–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞:**
   - ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (–Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)
   - ‚úÖ –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç –∏–º–µ–Ω–Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–∞
   - ‚úÖ –ü–æ–∫—Ä—ã—Ç—ã edge cases (–ø—É—Å—Ç—ã–µ —Å–¥–µ–ª–∫–∏, —Ä–∞–∑–Ω—ã–µ —Ä–µ–∂–∏–º—ã, –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è)
   - ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã (runner reset ‚Äî –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º)

4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
   - ‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ
   - ‚úÖ Docstrings –≤ —Ç–µ—Å—Ç–∞—Ö —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
   - ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

#### üöÄ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤

```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ—è
pytest tests/portfolio/ -v

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–µ—Å—Ç
pytest tests/portfolio/test_portfolio_single_trade.py -v

# –¢–µ—Å—Ç—ã runner reset
pytest tests/portfolio/test_portfolio_runner_reset.py -v

# –ö—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥
pytest tests/portfolio/ -q
```

---

## [Phase 4] - 2025-01-XX

### –ó–∞–≤–µ—Ä—à–µ–Ω–∞ –§–∞–∑–∞ 4: –ü–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã–π —Å–ª–æ–π

#### üéØ –¶–µ–ª—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã–π —Å–ª–æ–π –ø–æ–≤–µ—Ä—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –¥–ª—è:
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –µ–¥–∏–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º –≤ SOL
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (—ç–∫—Å–ø–æ–∑–∏—Ü–∏—è, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π)
- –£—á–µ—Ç–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–æ–º–∏—Å—Å–∏–π –∏ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è
- –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ equity curve –∏ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

#### üìÅ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö

##### 1. **–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å `backtester/domain/portfolio.py`**

**–¶–µ–ª—å:** –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ –¥–≤–∏–∂–∫–∞ –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏ —Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–π –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- `FeeModel` - –º–æ–¥–µ–ª—å –∫–æ–º–∏—Å—Å–∏–π –∏ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è
  - `swap_fee_pct` - –∫–æ–º–∏—Å—Å–∏—è swap (0.3% –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  - `lp_fee_pct` - –∫–æ–º–∏—Å—Å–∏—è LP (0.1% –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  - `slippage_pct` - –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ (10% –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  - `network_fee_sol` - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è —Å–µ—Ç–∏ (0.0005 SOL)
  - –ú–µ—Ç–æ–¥ `effective_fee_pct()` - —Ä–∞—Å—á–µ—Ç —Å—É–º–º–∞—Ä–Ω—ã—Ö –∫–æ–º–∏—Å—Å–∏–π round-trip

- `PortfolioConfig` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è
  - `initial_balance_sol` - –Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å (10.0 SOL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  - `allocation_mode` - —Ä–µ–∂–∏–º –∞–ª–ª–æ–∫–∞—Ü–∏–∏ ("fixed" –∏–ª–∏ "dynamic")
  - `percent_per_trade` - –¥–æ–ª—è –∫–∞–ø–∏—Ç–∞–ª–∞ –Ω–∞ —Å–¥–µ–ª–∫—É (10% –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  - `max_exposure` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–∫—Å–ø–æ–∑–∏—Ü–∏—è (50% –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  - `max_open_positions` - –º–∞–∫—Å–∏–º—É–º –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π (10 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  - `backtest_start/end` - –æ–∫–Ω–æ –±—ç–∫—Ç–µ—Å—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  - `runner_reset_enabled` - —Ñ–ª–∞–≥ –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞ Runner-XN

- `PortfolioStats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è
  - `final_balance_sol` - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
  - `total_return_pct` - –æ–±—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å
  - `max_drawdown_pct` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞
  - `trades_executed` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
  - `trades_skipped_by_risk` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫

- `PortfolioResult` - —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏
  - `equity_curve` - –∫—Ä–∏–≤–∞—è –±–∞–ª–∞–Ω—Å–∞ (—Å–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ {timestamp, balance})
  - `positions` - —Å–ø–∏—Å–æ–∫ –∑–∞–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
  - `stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è

- `PortfolioEngine` - –¥–≤–∏–∂–æ–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏
  - –ú–µ—Ç–æ–¥ `simulate()` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏:
    1. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–¥–µ–ª–æ–∫ –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ backtest window
    2. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ entry_time
    3. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–¥–µ–ª–æ–∫ —Å –∑–∞–∫—Ä—ã—Ç–∏–µ–º –ø–æ–∑–∏—Ü–∏–π
    4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—è (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π, —ç–∫—Å–ø–æ–∑–∏—Ü–∏—è)
    5. –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ (fixed/dynamic)
    6. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–π –∫ PnL
    7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∏ equity curve
    8. –†–∞—Å—á–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è —Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–π
- ‚úÖ –ü–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –ø–µ—Ä–µ—ç–∫—Å–ø–æ–∑–∏—Ü–∏—é
- ‚úÖ Equity curve –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∏–Ω–∞–º–∏–∫–∏ –±–∞–ª–∞–Ω—Å–∞
- ‚úÖ –ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

##### 2. **–û–±–Ω–æ–≤–ª–µ–Ω `backtester/domain/position.py`**

**–¶–µ–ª—å:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ–ª—è `meta` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏.

**–ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ:**
- `meta: Dict[str, Any] = None` ‚Üí `meta: Dict[str, Any] = field(default_factory=dict)`

**–ü—Ä–∏—á–∏–Ω–∞:** 
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ None
- –£–ø—Ä–æ—â–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (strategy, raw_pnl_pct, fee_pct, pnl_sol)

##### 3. **–û–±–Ω–æ–≤–ª–µ–Ω `backtester/application/runner.py`**

**–¶–µ–ª—å:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ –¥–≤–∏–∂–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å –±—ç–∫—Ç–µ—Å—Ç–∏–Ω–≥–∞.

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ò–º–ø–æ—Ä—Ç—ã: `PortfolioConfig`, `PortfolioEngine`, `FeeModel`, `PortfolioResult`
- –ê—Ç—Ä–∏–±—É—Ç `self.portfolio_results: Dict[str, PortfolioResult]` - —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º
- –ú–µ—Ç–æ–¥ `_build_portfolio_config()` - –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è –∏–∑ YAML:
  - –ü–∞—Ä—Å–∏–Ω–≥ —Å–µ–∫—Ü–∏–∏ `backtest` (start_at, end_at)
  - –ü–∞—Ä—Å–∏–Ω–≥ —Å–µ–∫—Ü–∏–∏ `portfolio` (–±–∞–ª–∞–Ω—Å, —Ä–µ–∂–∏–º –∞–ª–ª–æ–∫–∞—Ü–∏–∏, –ª–∏–º–∏—Ç—ã)
  - –ü–∞—Ä—Å–∏–Ω–≥ —Å–µ–∫—Ü–∏–∏ `fee` (–∫–æ–º–∏—Å—Å–∏–∏ –∏ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ)
  - –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ `FeeModel` –∏ `PortfolioConfig`

- –ú–µ—Ç–æ–¥ `run_portfolio()` - –∑–∞–ø—É—Å–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏:
  - –ü–æ–ª—É—á–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–º–µ–Ω —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  - –ó–∞–ø—É—Å–∫ `PortfolioEngine.simulate()` –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ `self.portfolio_results`
  - –í—ã–≤–æ–¥ –∫—Ä–∞—Ç–∫–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ—è
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å–æ –≤—Å–µ–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∏—Ö –∫–æ–¥–µ
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ YAML

##### 4. **–û–±–Ω–æ–≤–ª–µ–Ω `backtester/infrastructure/reporter.py`**

**–¶–µ–ª—å:** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ú–µ—Ç–æ–¥ `save_portfolio_results()` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:
  - `{strategy_name}_equity_curve.csv` - –∫—Ä–∏–≤–∞—è –±–∞–ª–∞–Ω—Å–∞
  - `{strategy_name}_portfolio_positions.csv` - –≤—Å–µ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
  - `{strategy_name}_portfolio_stats.json` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è
  - –í—ã–∑–æ–≤ `plot_portfolio_equity_curve()` –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞

- –ú–µ—Ç–æ–¥ `plot_portfolio_equity_curve()` - –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ equity curve:
  - –í—Ä–µ–º–µ–Ω–Ω–∞—è —Å–µ—Ä–∏—è –±–∞–ª–∞–Ω—Å–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è
  - –õ–∏–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `{strategy_name}_portfolio_equity.png`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü–æ–ª–Ω–∞—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å –ø–æ –ø–æ—Ä—Ç—Ñ–µ–ª—é
- ‚úÖ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–Ω–∞–º–∏–∫–∏ –±–∞–ª–∞–Ω—Å–∞
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏

##### 5. **–û–±–Ω–æ–≤–ª–µ–Ω `config/backtest_example.yaml`**

**–¶–µ–ª—å:** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ—è.

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- –°–µ–∫—Ü–∏—è `backtest`:
  - `start_at` - –Ω–∞—á–∞–ª–æ –æ–∫–Ω–∞ –±—ç–∫—Ç–µ—Å—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  - `end_at` - –∫–æ–Ω–µ—Ü –æ–∫–Ω–∞ –±—ç–∫—Ç–µ—Å—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

- –°–µ–∫—Ü–∏—è `portfolio`:
  - `initial_balance_sol: 10.0` - –Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
  - `allocation_mode: "dynamic"` - —Ä–µ–∂–∏–º –∞–ª–ª–æ–∫–∞—Ü–∏–∏
  - `percent_per_trade: 0.1` - –¥–æ–ª—è –∫–∞–ø–∏—Ç–∞–ª–∞ –Ω–∞ —Å–¥–µ–ª–∫—É
  - `max_exposure: 0.5` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–∫—Å–ø–æ–∑–∏—Ü–∏—è
  - `max_open_positions: 10` - –º–∞–∫—Å–∏–º—É–º –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
  - `runner_reset_enabled: false` - —Ñ–ª–∞–≥ –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
  - –°–µ–∫—Ü–∏—è `fee`:
    - `swap_fee_pct: 0.003` - –∫–æ–º–∏—Å—Å–∏—è swap (0.3%)
    - `lp_fee_pct: 0.001` - –∫–æ–º–∏—Å—Å–∏—è LP (0.1%)
    - `slippage_pct: 0.10` - –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ (10%)
    - `network_fee_sol: 0.0005` - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è —Å–µ—Ç–∏

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- ‚úÖ –õ–µ–≥–∫–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏—è–º–∏

##### 6. **–û–±–Ω–æ–≤–ª–µ–Ω `main.py`**

**–¶–µ–ª—å:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å.

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π (`runner.run()`) –¥–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `runner.run_portfolio()`
- –í—ã–≤–æ–¥ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ "PORTFOLIO SIMULATION"
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ `reporter.save_portfolio_results()`
- –í—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π workflow
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

##### 7. **–°–æ–∑–¥–∞–Ω `docs/PORTFOLIO_LAYER.md`**

**–¶–µ–ª—å:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- –û–±–∑–æ—Ä –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ—è
- –û–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ –º–æ–¥—É–ª–µ–π
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
- –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ –¥–≤–∏–∂–∫–∞
- –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

#### üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ—è —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å:

1. **–£—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏:**
   - –ö–æ–º–∏—Å—Å–∏–∏ swap –∏ LP
   - –ü—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ (10% –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
   - –°–µ—Ç–µ–≤—ã–µ –∫–æ–º–∏—Å—Å–∏–∏

2. **–ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
   - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–∫—Å–ø–æ–∑–∏—Ü–∏—è
   - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π

3. **–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—É—é –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å:**
   - Equity curve (–∫—Ä–∏–≤–∞—è –±–∞–ª–∞–Ω—Å–∞)
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è (return, drawdown, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫)
   - –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –ø–æ–∑–∏—Ü–∏—è–º

4. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç backtest window:**
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –¥–∞—Ç–∞–º –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–¥–µ–ª–æ–∫ –ø–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–º—É –æ–∫–Ω—É

#### üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–≥–æ –¥–≤–∏–∂–∫–∞

1. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:** –û—Ç–±–∏—Ä–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–¥–µ–ª–∫–∏ —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ entry_time –∏ exit_time –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö backtest window
2. **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:** –°–¥–µ–ª–∫–∏ —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ entry_time
3. **–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π:** –ü–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö exit_time <= entry_time –Ω–æ–≤–æ–π
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤:** 
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è —ç–∫—Å–ø–æ–∑–∏—Ü–∏—è
5. **–†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏:** –ù–∞ –æ—Å–Ω–æ–≤–µ allocation_mode –∏ percent_per_trade
6. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–π:** –ò–∑ PnL –≤—ã—á–∏—Ç–∞—é—Ç—Å—è –∫–æ–º–∏—Å—Å–∏–∏ –∏ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ
7. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞:** –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–π
8. **–†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:** –§–∏–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å, –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å, –ø—Ä–æ—Å–∞–¥–∫–∞

#### üìà –°–æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã

–î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è:
- `{strategy_name}_equity_curve.csv` - –∫—Ä–∏–≤–∞—è –±–∞–ª–∞–Ω—Å–∞
- `{strategy_name}_portfolio_positions.csv` - –≤—Å–µ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
- `{strategy_name}_portfolio_stats.json` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è
- `{strategy_name}_portfolio_equity.png` - –≥—Ä–∞—Ñ–∏–∫ equity curve

#### üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```bash
python main.py
```

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –ó–∞–ø—É—Å—Ç–∏—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
2. –ó–∞–ø—É—Å—Ç–∏—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—É—é —Å–∏–º—É–ª—è—Ü–∏—é
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

#### üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –†–µ–∂–∏–º Runner-XN (–∑–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ XN –ª—é–±–æ–π –ø–æ–∑–∏—Ü–∏–µ–π)
- [ ] –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∫–æ–º–∏—Å—Å–∏–π
- [ ] –£—á–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π
- [ ] –ü–æ—Ä—Ç—Ñ–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

---

## [Phase 3] - 2025-01-XX

### –ó–∞–≤–µ—Ä—à–µ–Ω–∞ –§–∞–∑–∞ 3: –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ –µ–¥–∏–Ω—ã–π RR-–¥–≤–∏–∂–æ–∫

#### üîß –ó–∞–¥–∞—á–∞ 1: –í—ã–Ω–µ—Å–µ–Ω–∞ –æ–±—â–∞—è RR-–ª–æ–≥–∏–∫–∞ –≤ —Ö–µ–ª–ø–µ—Ä

**–°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `backtester/domain/rr_utils.py`:**
- –§—É–Ω–∫—Ü–∏—è `apply_rr_logic()` - –æ–±—â–∞—è –ª–æ–≥–∏–∫–∞ TP/SL/timeout –¥–ª—è –≤—Å–µ—Ö RR-—Å—Ç—Ä–∞—Ç–µ–≥–∏–π
- –§—É–Ω–∫—Ü–∏—è `check_candle_quality()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–≤–µ—á–µ–π
- –§—É–Ω–∫—Ü–∏—è `calculate_volatility_around_entry()` - —Ä–∞—Å—á–µ—Ç –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
- –§—É–Ω–∫—Ü–∏—è `calculate_signal_to_entry_delay()` - —Ä–∞—Å—á–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ –≤—Ö–æ–¥–∞

**–û–±–Ω–æ–≤–ª–µ–Ω—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:**
- `RRStrategy` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `apply_rr_logic()` –≤–º–µ—Å—Ç–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
- `RRDStrategy` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `apply_rr_logic()` –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –∫–æ–¥–∞
- ‚úÖ RR –∏ RRD —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã
- ‚úÖ –õ–µ–≥—á–µ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (RRR, RRTS, Trailing RR)

#### üîß –ó–∞–¥–∞—á–∞ 2: –î–æ–±–∞–≤–ª–µ–Ω—ã ATR-—Ñ–∏–ª—å—Ç—Ä—ã –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–≤–µ—á–µ–π

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–≤–µ—á–µ–π:**
- ‚úÖ `volume > 0` - –æ–±—ä–µ–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º
- ‚úÖ `high >= low` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å OHLC –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ `high >= open/close` –∏ `low <= open/close` - –ª–æ–≥–∏–∫–∞ —Å–≤–µ—á–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–∞—á–∫–æ–≤ —Ü–µ–Ω—ã - –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–¥–µ–ª–∫–∏ –ø—Ä–∏ –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö —Å–∫–∞—á–∫–∞—Ö (> X% –∑–∞ 1 –º–∏–Ω—É—Ç—É)

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- `RRStrategy` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Å–≤–µ—á–∏ –≤—Ö–æ–¥–∞
- `RRDStrategy` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –≤—Å–µ—Ö —Å–≤–µ—á–µ–π –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –≤—Ö–æ–¥–∞ (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∞–Ω–æ–º–∞–ª—å–Ω—ã–µ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º)

**–ü–∞—Ä–∞–º–µ—Ç—Ä `max_price_jump_pct`** –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0.5%)

#### üîß –ó–∞–¥–∞—á–∞ 3: –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ StrategyOutput.meta

**–ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- ‚úÖ `minutes_in_market` - –≤—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö
- ‚úÖ `max_favorable_excursion` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –¥–æ –≤—ã—Ö–æ–¥–∞ (–≤ –¥–æ–ª—è—Ö)
- ‚úÖ `max_adverse_excursion` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É–±—ã—Ç–æ–∫ –¥–æ –≤—ã—Ö–æ–¥–∞ (–≤ –¥–æ–ª—è—Ö)
- ‚úÖ `volatility_around_entry` - –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –≤–æ–∫—Ä—É–≥ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ (–≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö)
- ‚úÖ `signal_to_entry_delay_minutes` - –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–∏–≥–Ω–∞–ª–æ–º –∏ –≤—Ö–æ–¥–æ–º (–≤ –º–∏–Ω—É—Ç–∞—Ö)

**–û—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è RRD-—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏**, –∫–æ—Ç–æ—Ä–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –∫ –∑–∞–¥–µ—Ä–∂–∫–µ –≤—Ö–æ–¥–∞.

#### üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

- ‚úÖ –°–æ–∑–¥–∞–Ω—ã unit-—Ç–µ—Å—Ç—ã –¥–ª—è `rr_utils.py` (`tests/domain/test_rr_utils.py`)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏
- ‚úÖ –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–µ–Ω –ª–∏–Ω—Ç–µ—Ä–æ–º - –æ—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ

---

## [Phase 2] - 2025-01-XX

### –ó–∞–≤–µ—Ä—à–µ–Ω–∞ –§–∞–∑–∞ 2: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –≤–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

#### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Ä—è–¥–æ–∫ –ø–æ–ª–µ–π OHLCV –≤ GeckoTerminalPriceLoader**
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ñ–æ—Ä–º–∞—Ç –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π: `[timestamp, open, high, low, close, volume]`

2. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω end_time –≤ –≤—ã–∑–æ–≤ loader.load_prices() –≤ rr_strategy.py**
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–µ—á–µ–π –≤—Ä–µ–º–µ–Ω–Ω—ã–º –æ–∫–Ω–æ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

#### –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

3. ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π**
   - –§—É–Ω–∫—Ü–∏—è `validate_candle()` —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ OHLCV –¥–∞–Ω–Ω—ã—Ö

4. ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π Reporter —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏**
   - –†–∞—Å—á–µ—Ç winrate, Sharpe ratio, max drawdown, profit factor –∏ –¥—Ä—É–≥–∏—Ö –º–µ—Ç—Ä–∏–∫
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è CSV, HTML –æ—Ç—á–µ—Ç–æ–≤ –∏ equity curve –≥—Ä–∞—Ñ–∏–∫–æ–≤

5. ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ RRD-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Å –≤—Ö–æ–¥–æ–º –ø–æ drawdown**
   - –ü–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤—Ö–æ–¥–∞ –ø–æ drawdown —Å TP/SL
   - –ü–∞—Ä–∞–º–µ—Ç—Ä `entry_wait_minutes` –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è –≤—Ö–æ–¥–∞

#### –ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

6. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω—ã unit-—Ç–µ—Å—Ç—ã**
   - –¢–µ—Å—Ç—ã –¥–ª—è RR, RRD –∏ Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

7. ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤**
   - ThreadPoolExecutor –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤

8. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∞ retry-–ª–æ–≥–∏–∫–∞ –¥–ª—è API**
   - –î–µ–∫–æ—Ä–∞—Ç–æ—Ä `retry_on_failure` —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π

9. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**
   - –ì—Ä–∞—Ñ–∏–∫–∏ equity curve, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è PnL, –ø—Ä–∏—á–∏–Ω—ã –≤—ã—Ö–æ–¥–∞, –≤—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ —Å–¥–µ–ª–æ–∫

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
backtester/
‚îú‚îÄ‚îÄ application/
‚îÇ   ‚îî‚îÄ‚îÄ runner.py           # BacktestRunner —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ models.py           # Signal, Candle, StrategyInput, StrategyOutput
‚îÇ   ‚îú‚îÄ‚îÄ strategy_base.py    # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å Strategy
‚îÇ   ‚îú‚îÄ‚îÄ rr_strategy.py      # RR —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç rr_utils)
‚îÇ   ‚îú‚îÄ‚îÄ rrd_strategy.py     # RRD —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç rr_utils)
‚îÇ   ‚îú‚îÄ‚îÄ rr_utils.py         # –û–±—â–∞—è RR-–ª–æ–≥–∏–∫–∞ –∏ —É—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ runner_strategy.py  # Runner —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
‚îî‚îÄ‚îÄ infrastructure/
    ‚îú‚îÄ‚îÄ signal_loader.py    # –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –∏–∑ CSV
    ‚îú‚îÄ‚îÄ price_loader.py     # –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–µ—á–µ–π (CSV + GeckoTerminal API)
    ‚îî‚îÄ‚îÄ reporter.py         # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ –∏ –º–µ—Ç—Ä–∏–∫

tests/
‚îî‚îÄ‚îÄ domain/
    ‚îú‚îÄ‚îÄ test_rr_strategy.py
    ‚îú‚îÄ‚îÄ test_rrd_strategy.py
    ‚îú‚îÄ‚îÄ test_runner_strategy.py
    ‚îî‚îÄ‚îÄ test_rr_utils.py
```


